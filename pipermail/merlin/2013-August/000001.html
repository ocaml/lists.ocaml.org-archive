<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Merlin-discuss] further integration of merlin at Jane Street
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:merlin%40lists.ocaml.org?Subject=Re%3A%20%5BMerlin-discuss%5D%20further%20integration%20of%20merlin%20at%20Jane%20Street&In-Reply-To=%3CCAK2%3DngA_kE_7QMFYscXqKZ3n2Jhbh_rJvViv5qstxmmX%2BFzDqg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000000.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Merlin-discuss] further integration of merlin at Jane Street</H1>
    <B>Frederic Bour</B> 
    <A HREF="mailto:merlin%40lists.ocaml.org?Subject=Re%3A%20%5BMerlin-discuss%5D%20further%20integration%20of%20merlin%20at%20Jane%20Street&In-Reply-To=%3CCAK2%3DngA_kE_7QMFYscXqKZ3n2Jhbh_rJvViv5qstxmmX%2BFzDqg%40mail.gmail.com%3E"
       TITLE="[Merlin-discuss] further integration of merlin at Jane Street">fbour
       </A><BR>
    <I>Tue Aug 27 11:01:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="000000.html">[Merlin-discuss] further integration of merlin at Jane Street
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1">[ date ]</a>
              <a href="thread.html#1">[ thread ]</a>
              <a href="subject.html#1">[ subject ]</a>
              <a href="author.html#1">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Here are some thoughts on further integrating merlin into the Jane
</I>&gt;<i> Street environment.  I preface this by saying I don't understand the
</I>&gt;<i> current merlin/emacs integration, so feel free to elucidate me.
</I>
More documentation should be coming soon.

&gt;<i> To state what I think is a goal:
</I>&gt;<i>
</I>&gt;<i>   A programmer should be able to go to any position in any OCaml
</I>&gt;<i>   source file on their machine, press a button, and autocomplete at
</I>&gt;<i>   that point (or be told that autocompletion isn't possible because
</I>&gt;<i>   the necessary libraries haven't been compiled).
</I>&gt;<i>
</I>&gt;<i> The first thing I think this implies is that we need to keep a merlin
</I>&gt;<i> installed for each ocaml that we install (i.e. /janelibs/ocaml-*/).
</I>&gt;<i> This is needed so that the merlin is compatible with the source and
</I>&gt;<i> object files for the project.  The merlin editor integration can
</I>&gt;<i> determine the correct merlin to run by looking at the .omake-ocaml-bin
</I>&gt;<i> at the root of the repo as generated by the build system.  Presumably
</I>&gt;<i> our deployment of merlin would put &quot;ocamlmerlin&quot; and related
</I>&gt;<i> executables in the same bin as ocamlc, ocamlopt, etc., or in some
</I>&gt;<i> fixed directory relative to that bin.
</I>&gt;<i>
</I>
Having one merlin per ocaml version seems to be the way to go.

We have been discussing this issue on
[<A HREF="https://github.com/def-lkb/merlin/issues/44">https://github.com/def-lkb/merlin/issues/44</A>]: we could support
different versions, by always using the latest typer, converting
cmi/cmt files, and relying on backward compatibility.

But this approach is likely to be fragile, at least at the beginning,
and adds a transformation pass that may need further caching.

To select the right merlin binary, we could make the build system
generate a symlink to the executable at the same time it produces the
&quot;.merlin&quot; file.

&gt;<i> Next, we need merlin to understand the libraries that are in scope in
</I>&gt;<i> a given directory.  I think this is a fairly straightforward matter of
</I>&gt;<i> having jenga output a .merlin for each directory that contains OCaml
</I>&gt;<i> files.  That .merlin would be complete, i.e. not require any recursion
</I>&gt;<i> up the directory tree.  The contents of the .merlin would be the
</I>&gt;<i> OCAML_LIBRARIES plus the libraries as recursively required by
</I>&gt;<i> OCAML_INTERFACES (i.e. whatever the build system is already making
</I>&gt;<i> available when compiling source files in that directory).
</I>
Yes.

&gt;<i> Next, I speculate that for performance reasons, we need a merlin
</I>&gt;<i> server to cache information so that it can quickly reconstruct the
</I>&gt;<i> environment at a given program point.  It might cache:
</I>&gt;<i>
</I>&gt;<i>   * the environment for each library
</I>&gt;<i>   * the environment that is the union of libraries imported for a
</I>&gt;<i>     directory
</I>&gt;<i>   * even more, perhaps the imported libraries plus all of the files in
</I>&gt;<i>     a directory
</I>&gt;<i>
</I>&gt;<i> A natural architecture for this is to have a merlin server process for
</I>&gt;<i> each project (i.e. per jengaroot).  When one first visits a project,
</I>&gt;<i> the merlin process would be created.  As one queries for
</I>&gt;<i> autocompletion in files in the project, that merlin process answers
</I>&gt;<i> the queries, using and updating its cache.
</I>
Did you observe slowdown for some workload?

In the current version, cmi files are cached when first read
(inheriting the behavior of ocaml compiler), and when receiving a
&quot;SIGUSR1&quot; merlin reload all cmi files having newer mtime. This signal
is sent to merlin by the build-system when a build finishes.
This is fast enough that it don't feel slow at all for my particular
workflow (this is subjective of course).

The slowest thing is retyping the current buffer, where most of the
time is spent on &quot;open Core.Std&quot;. This has been optimized in the
experimental branch, which we plan to merge soon.

&gt;<i> To support multiple simultaneous projects, one needs to manage a set
</I>&gt;<i> of merlin processes (with possibly different merlin versions).  It is
</I>&gt;<i> unclear whether the process management should be written separately
</I>&gt;<i> for each editor, or whether we should write a &quot;meta-merlin&quot; in OCaml
</I>&gt;<i> that presents a unified command-line interface that could then be used
</I>&gt;<i> by any editor.  At Jane Street, we need to support emacs and vim, so
</I>&gt;<i> there is at least some advantage to a meta-merlin written in OCaml.
</I>&gt;<i> But if the process management is simple enough in each editor, then
</I>&gt;<i> perhaps an OCaml meta-merlin isn't worth it.
</I>&gt;<i>
</I>&gt;<i> We already have an analog of meta-merlin at Jane Street -- it's called
</I>&gt;<i> omake-server, which manages a collection of per-project build
</I>&gt;<i> processes.  I chatted with Pete about the possibility of implementing
</I>&gt;<i> meta-merlin.  Roughly, we think that having ocaml-server has worked
</I>&gt;<i> out well, although there are a number of ways in which the
</I>&gt;<i> implementation is too complicated.  So, if we write meta-merlin, we'd
</I>&gt;<i> like to start with a new codebase, with heavy involvement from Pete to
</I>&gt;<i> avoid some of the design mistakes of omake-server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That's probably enough for now.  Hopefully people who understand the
</I>&gt;<i> merlin architecture can speak up so we can all understand it clearly,
</I>&gt;<i> and we can then decide how to proceed to get a merlin that works
</I>&gt;<i> smoothly for all Jane Street devs.
</I>
The current implementation can make use of multiple processes (managed
by the editor). But the setup you suggest seems much more complicated,
I hardly see the benefits.
Is this only for performance reasons?


Fr?d?ric

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000000.html">[Merlin-discuss] further integration of merlin at Jane Street
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1">[ date ]</a>
              <a href="thread.html#1">[ thread ]</a>
              <a href="subject.html#1">[ subject ]</a>
              <a href="author.html#1">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ocaml.org/listinfo/merlin">More information about the Merlin
mailing list</a><br>
</body></html>

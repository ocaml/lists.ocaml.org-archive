<tt>
Dear&nbsp;wg-camp4&nbsp;users,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;So&nbsp;far,&nbsp; the&nbsp;discussion&nbsp;is&nbsp;really&nbsp;interesting&nbsp;and&nbsp;quite&nbsp;helpful,&nbsp;but&nbsp;I&nbsp;want&nbsp;to&nbsp;talk&nbsp;about&nbsp;the&nbsp;meta-programming&nbsp;&lt;b&gt;from&nbsp;the&nbsp;point&nbsp;of&nbsp;the&nbsp;view&nbsp;of&nbsp;implementation&nbsp;side,&lt;/b&gt;&nbsp;features&nbsp;are&nbsp;easy&nbsp;to&nbsp;propose,&nbsp;but&nbsp;maybe&nbsp;only&nbsp;the&nbsp;compiler/library&nbsp;writers&nbsp;know&nbsp;how&nbsp;hard&nbsp;to&nbsp;implement,&nbsp;I&nbsp;do&nbsp;appreciate&nbsp;that&nbsp;you&nbsp;can&nbsp;sit&nbsp;dow&nbsp;and&nbsp;read&nbsp;the&nbsp;long&nbsp;email,&nbsp;I&nbsp;am&nbsp;also&nbsp;starting&nbsp;to&nbsp;blog(&lt;a&nbsp;href=&quot;http://hongboz.wordpress.com/&quot;&gt;http://hongboz.wordpress.com/&lt;/a&gt;)&nbsp;about&nbsp;how&nbsp;to&nbsp;do&nbsp;syntactic&nbsp;meta&nbsp;programming&nbsp;(SMP)&nbsp;in&nbsp;a&nbsp;right&nbsp;way.&lt;/div&gt;<br>
&lt;div&gt; &nbsp; I&nbsp;rewrite&nbsp;the&nbsp;whole&nbsp;camlP4(named&nbsp;Fan)&nbsp;from&nbsp;scratch,&nbsp;building&nbsp;the&nbsp;quotation&nbsp;kit&nbsp;and&nbsp;throw&nbsp;away&nbsp;the&nbsp;crappy&nbsp;grammar&nbsp;parser,&nbsp;so&nbsp;plz&nbsp;believe&nbsp;me&nbsp;&lt;b&gt;that&nbsp;I&nbsp;do&nbsp;understand&nbsp;the&nbsp;whole&nbsp;technology&nbsp;stack&nbsp;of&nbsp;camlP4&lt;/b&gt;,&nbsp;if&nbsp;we&nbsp;could&nbsp;reach&nbsp;some&nbsp;consensus,&nbsp;I&nbsp;would&nbsp;be&nbsp;happy&nbsp;to&nbsp;handle&nbsp;over&nbsp;the&nbsp;maintaining&nbsp;of&nbsp; Fan,&nbsp;Fan&nbsp;does&nbsp;not&nbsp;loose&nbsp;any&nbsp;feature&nbsp;compared&nbsp;with&nbsp;camlP4,&nbsp;in&nbsp;fact&nbsp;it&nbsp;has&nbsp;more&nbsp;interesting&nbsp;featrues.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; Let&#39;s&nbsp;begin&nbsp;with&nbsp;some&nbsp;easy,&nbsp;not&nbsp;too&nbsp;technical&nbsp;parts&nbsp;which&nbsp;has&nbsp;a&nbsp;significant&nbsp;effect&nbsp;on&nbsp;user&nbsp;experience&nbsp;though:&lt;/div&gt;&lt;div&gt; &nbsp; 1.&nbsp;Performance&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Performance&nbsp;does&nbsp;matter,&nbsp;it&#39;s&nbsp;a&nbsp;shame&nbsp;that&nbsp; the&nbsp;most&nbsp;time&nbsp;spent&nbsp;in&nbsp;compiling&nbsp;the&nbsp;ocaml&nbsp;compiler&nbsp;is&nbsp;dedicated&nbsp;to&nbsp;camlP4,&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;engineering&nbsp;problem,&nbsp;currently&nbsp;compiling&nbsp;Fan&nbsp;only&nbsp;takes&nbsp;less&nbsp;than&nbsp;20s,&nbsp;and&nbsp;it&nbsp;can&nbsp;be&nbsp;improved&nbsp;further&lt;/div&gt;<br>
&lt;div&gt; &nbsp; 2.&nbsp;Building&nbsp;issues&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;The&nbsp;design&nbsp;of&nbsp;having&nbsp;side&nbsp;effects&nbsp;by&nbsp;dynamic&nbsp;loading&nbsp;is&nbsp;generically&nbsp;a&nbsp;bad&nbsp;idea,&nbsp;in&nbsp;Fan&lt;b&gt;&nbsp;the&nbsp;dynamic&nbsp;loading&nbsp;only&nbsp;register&nbsp;some&nbsp;functionality&nbsp;the&nbsp;Fan&nbsp;support,&lt;/b&gt;&nbsp;it&nbsp;&lt;b&gt;does&nbsp;not&nbsp;have&nbsp;any&nbsp;other&nbsp;side&nbsp;effec&lt;/b&gt;t,&nbsp;each&nbsp;file&nbsp;stands&nbsp;alone&nbsp;says&nbsp;which&nbsp;(ppx&nbsp;,&nbsp;or&nbsp;filters,&nbsp;or&nbsp;syntax)&nbsp;it&nbsp;want&nbsp;to&nbsp;use&nbsp;with&nbsp;a&nbsp;good&nbsp;default&nbsp;option.&nbsp;so&nbsp;the&nbsp;building&nbsp;is&nbsp;always&nbsp;something&nbsp;like&nbsp;&#39;-pp&nbsp;fan&nbsp;pluging1&nbsp;plugin2&nbsp;plugin3&#39;,&nbsp;&lt;b&gt;the&nbsp;order&nbsp;of&nbsp;pulgings&nbsp;does&nbsp;not&nbsp;matter&lt;/b&gt;,&nbsp;also,&nbsp;l&lt;b&gt;oading&nbsp;all&nbsp;the&nbsp;plugins&nbsp;you&nbsp;have&nbsp;does&nbsp;not&nbsp;have&nbsp;any&nbsp;side&nbsp;effect,&nbsp;even&nbsp;better,&nbsp;you&nbsp;can&nbsp;do&nbsp;the&nbsp;static&nbsp;linking&nbsp;all&nbsp;the&nbsp;plugins&nbsp;you&nbsp;collected,&nbsp;the&nbsp;building&nbsp;process&nbsp;is&nbsp;simplified.&nbsp; &lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt; &lt;/b&gt;&nbsp;3.&nbsp;Grammar&nbsp;Extension&nbsp;(&lt;b&gt;Language&nbsp;namespace&lt;/b&gt;)&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &lt;/b&gt;I&nbsp;concur&nbsp;that&nbsp;grammar&nbsp;extension&nbsp;arbitrarily&nbsp;is&nbsp;a&nbsp;bad&nbsp;idea,&nbsp;and&nbsp;I&nbsp;agree&nbsp;with&nbsp;Gabrier&nbsp;that&nbsp;so&nbsp;far&nbsp;only&nbsp;the&nbsp;quotation(Here&nbsp; quotation&nbsp;means&nbsp;delimited&nbsp;DSL,&nbsp;quosi-quotation&nbsp;means&nbsp;Lisp&nbsp;style&nbsp;macros)&nbsp;is&nbsp;modular,&nbsp;composable,&nbsp;and&nbsp; I&nbsp;also&nbsp;agree&nbsp;with&nbsp;Gabrier&nbsp;-ppx&lt;b&gt;&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;to&nbsp;do&nbsp;syntax&nbsp;overriding&nbsp;(this&nbsp;should&nbsp;not&nbsp;be&nbsp;called&nbsp;syntax&nbsp;extension&nbsp;actually),&nbsp;&lt;/b&gt;that&#39;s&nbsp;a&nbsp;terrible&nbsp;idea&nbsp;to&nbsp;do&nbsp;syntax&nbsp;overriding,&nbsp;since&nbsp;the&nbsp;user&nbsp;never&nbsp;understand&nbsp;what&#39;s&nbsp;going&nbsp;on&nbsp;underly&nbsp;without&nbsp;reading&nbsp;the&nbsp;Makefile.&nbsp;So&nbsp;here&nbsp;some&nbsp;my&nbsp;suggestion&nbsp;is&nbsp;that&nbsp;some&nbsp;really&nbsp;conevenient&nbsp;syntax&nbsp;extesion,&nbsp;i.e,&nbsp;(let&nbsp;try..&nbsp;in)&nbsp;should&nbsp;be&nbsp;merged&nbsp;to&nbsp;the&nbsp;built&nbsp;in&nbsp;parser.&nbsp;quotations&nbsp;does&nbsp;not&nbsp;bring&nbsp;too&nbsp;much&nbsp;heavy&nbsp;syntax&nbsp;(imho).&nbsp;In&nbsp;Fan,&nbsp;we&nbsp;proposed&nbsp;the&nbsp;concept&nbsp;of&nbsp;a&nbsp;hierarchical&nbsp;language&nbsp;name&nbsp;space,&nbsp;since&nbsp;once&nbsp;quotation&nbsp;is&nbsp;heavily&nbsp;used,&nbsp;it&#39;s&nbsp;really&nbsp;easy&nbsp;to&nbsp;introduce&nbsp;conflict,&nbsp;&lt;b&gt;the&nbsp;language&nbsp;namespace&nbsp;querying&nbsp;is&nbsp;exactly&nbsp;like&nbsp;java&nbsp;package&nbsp;namespace,&lt;/b&gt;&nbsp;you&nbsp;can&nbsp;import,&nbsp;close&nbsp;import&nbsp;to&nbsp;save&nbsp;some&nbsp;typing.&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp;Here&nbsp;is&nbsp;a&nbsp;taste&lt;/div&gt;&lt;div&gt; &nbsp; -----------------------------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; {:.Fan.Lang.Meta.expr|&nbsp;a&nbsp;+&nbsp;b&nbsp;|}&nbsp;------&gt; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;  &lt;span&nbsp;style=&quot;background-color:rgb(255,255,255);color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px&quot;&gt;`App&nbsp;(`App&nbsp;((`Id&nbsp;(`Lid&nbsp;&quot;+&quot;)),&nbsp;(`Id&nbsp;(`Lid&nbsp;&quot;a&quot;)))),&nbsp;(`Id&nbsp;(`Lid&nbsp;&quot;b&quot;)))&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; {:.Fan.Lang.Meta.N.expr|&nbsp;a&nbsp;+&nbsp;b&nbsp;|}&nbsp; -----&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;  &lt;span&nbsp;style=&quot;background-color:rgb(255,255,255);color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px&quot;&gt;`App&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px;background-color:rgb(255,255,255)&quot;&gt;<br>
 &nbsp; &nbsp;(_loc,&lt;/div&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px;background-color:rgb(255,255,255)&quot;&gt; &nbsp; &nbsp; &nbsp;(`App&lt;/div&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px;background-color:rgb(255,255,255)&quot;&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; (_loc,&nbsp;(`Id&nbsp;(_loc,&nbsp;(`Lid&nbsp;(_loc,&nbsp;&quot;+&quot;)))),&lt;/div&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px;background-color:rgb(255,255,255)&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (`Id&nbsp;(_loc,&nbsp;(`Lid&nbsp;(_loc,&nbsp;&quot;a&quot;)))))),&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;background-color:rgb(255,255,255);color:rgb(34,34,34);font-family:arial,sans-serif;font-size:12.800000190734863px&quot;&gt; &nbsp; &nbsp; &nbsp;(`Id&nbsp;(_loc,&nbsp;(`Lid&nbsp;(_loc,&nbsp;&quot;b&quot;)))))&lt;/span&gt; &lt;/div&gt;&lt;div&gt;&lt;div&gt; -----------------------------------------------------------------------------------------------&lt;/div&gt;<br>
&lt;div&gt; the&nbsp;.Fan.Lang.Meta.expr&nbsp;the&nbsp;first&nbsp;&#39;.&#39;&nbsp;means&nbsp;it&#39;s&nbsp;from&nbsp;the&nbsp;absolute&nbsp;namespace,&nbsp; the &lt;b&gt;N.expr&nbsp;shares&nbsp;exactly&nbsp;the&nbsp;same&nbsp;syntax&nbsp;without&nbsp;location&lt;/b&gt;,&nbsp;though&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; 4.&nbsp;Portable&nbsp;to&nbsp;diffierrent&nbsp;compiler&nbsp;extensions(like&nbsp;LexiFi&#39;s&nbsp;fork&nbsp;of&nbsp;ocaml)&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; I&nbsp;am&nbsp;pretty&nbsp;sure&nbsp;it&#39;s&nbsp;pretty&nbsp;easy&nbsp;to&nbsp;do&nbsp;in&nbsp;Fan,&nbsp;only&nbsp;Ast2pt&nbsp;(dumping&nbsp;the&nbsp;intemediate&nbsp;Ast&nbsp;into&nbsp;Parsetree)&nbsp;part&nbsp;need&nbsp;to&nbsp;be&nbsp;changed&nbsp;to&nbsp;diffierent&nbsp;compilers.&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;----------------------------------------------------------------------------------------------------------------&lt;/div&gt;<br>
&lt;div&gt;Now&nbsp;let&#39;s&nbsp;talk&nbsp;about&nbsp;some&nbsp;internal&nbsp;parts&nbsp;of&nbsp;SMP.&lt;/div&gt;&lt;div&gt;Quasi-Quotation&nbsp;is&nbsp;the&nbsp;essential&nbsp;part&nbsp;of&nbsp;SMP,&nbsp; I&nbsp;am&nbsp;surprised&nbsp;so&nbsp;far&nbsp;that&nbsp;the&nbsp;discussion&nbsp;&lt;b&gt;silently&nbsp;ignores&nbsp;the&nbsp;quasi-quotation,&lt;/b&gt;&nbsp;Leo&#39;s&nbsp;answer&nbsp;of&nbsp;writing&nbsp; &nbsp;three&nbsp;parsers&nbsp;is&nbsp;neither&nbsp;satisfying&nbsp;nor&nbsp;practical(imho). &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Camlp4&nbsp;is&nbsp;mainly&nbsp;composed&nbsp;of&nbsp;two&nbsp;parts,&nbsp;one&nbsp;is&nbsp;the&nbsp;extensible&nbsp;parser&nbsp;and&nbsp;&lt;b&gt;the&nbsp;other&nbsp;significant&nbsp;part&nbsp;is&nbsp;Ast&nbsp;Lifting&lt;/b&gt;.&nbsp;Since&nbsp;we&nbsp;all&nbsp;agree&nbsp;that&nbsp;extensible&nbsp;parser&nbsp;increases&nbsp;the&nbsp;complexity&nbsp;too&nbsp;much,&nbsp;let&#39;s&nbsp;simply&nbsp;ignore&nbsp;that&nbsp;part.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;Ast&nbsp;Lifting&nbsp;are&nbsp;tightly&nbsp;coupled&nbsp;&lt;b&gt;with&nbsp;the&nbsp;design&nbsp;of&nbsp;the&nbsp;Abstract&nbsp;Syntax&nbsp;Tree.&lt;/b&gt; &nbsp;People&nbsp;complain&nbsp;about&nbsp;that&nbsp;Camlp4&nbsp;Ast&nbsp;is&nbsp;hard&nbsp;to&nbsp;learn&nbsp;and&nbsp;using&nbsp;quasi-quotation&nbsp;to&nbsp;do&nbsp;the&nbsp;pattern&nbsp;match&nbsp;is&nbsp;a&nbsp;bad&nbsp;idea.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Let&nbsp;me&nbsp;explain&nbsp;the&nbsp;topic&nbsp;a&nbsp;bit:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;Camlp4Ast&nbsp;is&nbsp;hard&nbsp;to&nbsp;learn,&nbsp;I&nbsp;agree,&nbsp;it&nbsp;has&nbsp;some&nbsp;alien&nbsp;names&nbsp;that&nbsp;nobody&nbsp;understand&nbsp;what&nbsp;it&nbsp; means,&nbsp;quosi-quotation&nbsp;&lt;b&gt;is&nbsp;definitely&nbsp;a&nbsp;great&nbsp;idea&lt;/b&gt;&nbsp;to&nbsp;boom&nbsp;the&nbsp;meta-programming,&nbsp;but&nbsp;my&nbsp;experience&nbsp;here&nbsp;is&nbsp;&lt;b&gt;for&nbsp;very&nbsp;very&nbsp;small&nbsp;Ast&nbsp;fragment,&nbsp;using&nbsp;the&nbsp;Abstract&nbsp;Syntax&nbsp;Tree&nbsp;directly,&lt;/b&gt; otherwise&nbsp;Quasi-quotation&nbsp;is&nbsp;a&nbsp;life&nbsp;saver&nbsp;to&nbsp;do&nbsp;the&nbsp;meta&nbsp;programming.&lt;/div&gt;<br>
&lt;div&gt; &nbsp; Luckily&nbsp;the&nbsp;quotation&nbsp;kit&nbsp;has&nbsp;nothing&nbsp;to&nbsp;do&nbsp;with&nbsp;the&nbsp;parser&nbsp;part,&nbsp;it&#39;s&nbsp;simply&nbsp;several&nbsp;functions(I&nbsp;did&nbsp;some&nbsp;simplify&nbsp;a&nbsp;bit)&nbsp;which&nbsp;turns&nbsp;a&nbsp;normal&nbsp;runtime&nbsp; &lt;/div&gt;&lt;div&gt;value&nbsp;into&nbsp;an&nbsp;Ast&nbsp;node&nbsp;generically,&nbsp;&lt;b&gt;such&nbsp;kind&nbsp;functions&nbsp;are&nbsp;neither&nbsp;easy&nbsp;to&nbsp;write&nbsp;nor&nbsp;easy&nbsp;to&nbsp;read&lt;/b&gt;,&nbsp;&lt;b&gt;the&nbsp;idea&nbsp;case&nbsp;is&nbsp;that&nbsp;it&nbsp;should&nbsp;be&nbsp;generated&nbsp;once&nbsp;for&nbsp;all,&nbsp;and&nbsp;all&nbsp;the&nbsp;data&nbsp;types&nbsp;in&nbsp;normal&nbsp;ocaml&lt;/b&gt;&nbsp;&lt;b&gt;should&nbsp;be&nbsp;derived&nbsp;automatically&lt;/b&gt;(some&nbsp;ADT&nbsp;with&nbsp;functions&nbsp;can&nbsp;not&nbsp;be&nbsp;derived).&nbsp;&lt;b&gt;I&nbsp;bet&nbsp;it&#39;s&nbsp;mostly&nbsp;likely&nbsp;a&nbsp;nightmare&nbsp;if&nbsp;we&nbsp;maintain&nbsp;3&nbsp;parsers&nbsp;for&nbsp;the&nbsp;ocaml&nbsp;grammar&nbsp;while&nbsp;two&nbsp;other&nbsp;parsers&nbsp;dumping&nbsp;to&nbsp;a&nbsp;meta-level&lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;  &lt;/div&gt;&lt;div&gt; &nbsp; So,&nbsp;how&nbsp;to&nbsp;make&nbsp;Ast&nbsp;Lifting&nbsp;easier, &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;The&nbsp;first&nbsp;guideline&nbsp;is&nbsp;&lt;b&gt;&quot;Don&#39;t&nbsp;mixing&nbsp;with&nbsp;records&quot;, &lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/b&gt;Once&nbsp;you&nbsp;encoding&nbsp;AST&nbsp;with&nbsp;records,&nbsp;you&nbsp;have&nbsp;to&nbsp;encode&nbsp;the&nbsp;records&nbsp;in&nbsp;the&nbsp;meta&nbsp;level&nbsp;which&nbsp;increases&nbsp;the&nbsp;complexity&nbsp;without&nbsp;bringing&nbsp;any&nbsp;new&nbsp;features,&nbsp;&lt;b&gt;it&#39;s&nbsp;simply&nbsp;not&nbsp;worthwhile.&lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &lt;/b&gt; The&nbsp;second&nbsp;guideline&nbsp;is&nbsp;&quot;Don&#39;t&nbsp;do&nbsp;&lt;b&gt;any&nbsp;&lt;/b&gt;syntax&nbsp;desugaring&quot;&nbsp;,&nbsp;syntax&nbsp;desguaring&nbsp;makes&nbsp;the&nbsp;semantics&nbsp;of&nbsp;syntax&nbsp;meta&nbsp;programming&nbsp;a&nbsp;bit&nbsp;weird.&nbsp;Syntax&nbsp;desguaring&nbsp;happens&nbsp;everywhere&nbsp;in&nbsp;Parsetree,&nbsp;think&nbsp;about&nbsp;the&nbsp;list&nbsp;literals,&nbsp;it&nbsp;uses&nbsp;the&nbsp;syntax&nbsp;desuaring,&nbsp;if&nbsp;you&nbsp;don&#39;t&nbsp;use&nbsp;any&nbsp;syntax&nbsp;desugaring,&nbsp;for&nbsp;example,&nbsp;you&nbsp;want&nbsp;to&nbsp;match&nbsp;the&nbsp;bigarray&nbsp;access,&nbsp;you&nbsp;simply&nbsp;needed&nbsp;to&nbsp;match&nbsp;`Bigarray(..)&#39;&nbsp;instead&nbsp;of &lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Pexp_apply&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;({pexp_desc=Pexp_ident&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {txt=&nbsp;Ldot&nbsp;(Ldot&nbsp;(Lident&nbsp;&quot;Bigarray&quot;,&nbsp;array),&nbsp;(&quot;get&quot;|&quot;set&quot;&nbsp;as&nbsp;gs))&nbsp;;_};_},&lt;/div&gt;&lt;div&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; label_exprs)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;----------------------------&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; The&nbsp;third&nbsp;guideline&nbsp;is&nbsp;to&lt;b&gt;&nbsp;&lt;/b&gt;make&nbsp;it&nbsp;&lt;b&gt;as&nbsp;uniform&nbsp;as&nbsp;possible&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &lt;/b&gt;This&nbsp;not&nbsp;only&nbsp;helps&nbsp;the&nbsp;user,&nbsp;but&nbsp;&lt;b&gt;it&nbsp;helps&nbsp;the&nbsp;meta-programming&nbsp;over&nbsp;types&nbsp;to&nbsp;derive&nbsp;some&nbsp;utility&nbsp;types.&nbsp;&lt;/b&gt;Take&nbsp;a&nbsp;look&nbsp;at&nbsp;my&nbsp;Ast&nbsp;encoding&nbsp;in&nbsp;Fan &lt;a&nbsp;href=&quot;https://github.com/bobzhang/Fan/blob/master/src/Ast.ml&quot;&gt;https://github.com/bobzhang/Fan/blob/master/src/Ast.ml&lt;/a&gt;&nbsp;(it&nbsp;needs&nbsp;to&nbsp;be&nbsp;polished,&nbsp;plz&nbsp;don&#39;t&nbsp;panic&nbsp;when&nbsp;you&nbsp;see&nbsp;variants&nbsp;I&nbsp;use&nbsp;here)&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp;&lt;/b&gt;The&nbsp;initial&nbsp;Ast&nbsp;has&nbsp;locations&nbsp;and&nbsp;ant&nbsp;support,&nbsp;but&lt;b&gt;&nbsp;here&nbsp;we&nbsp;derive&nbsp;3&nbsp;other&nbsp;Asts&nbsp;thanks&nbsp;to&nbsp;my&nbsp;very&nbsp;regular&nbsp;design&lt;/b&gt;.&lt;b&gt;&nbsp;AstN&nbsp;is&nbsp;the&nbsp;Ast&nbsp;without&nbsp;locations&lt;/b&gt;,&nbsp;the&nbsp;locations&nbsp;are&nbsp;important,&nbsp;but&nbsp;it&nbsp;is&nbsp;simply&nbsp;not&nbsp;too&nbsp;much&nbsp;helpful&nbsp;when&nbsp;you&nbsp;only&nbsp;do&nbsp;the&nbsp;code&nbsp;generation,&nbsp;but&nbsp;it&nbsp;complicates&nbsp;the&nbsp;expanded&nbsp;code&nbsp;a&nbsp;lot),&nbsp;&lt;b&gt;AstA&nbsp;is&nbsp;the&nbsp;Ast&nbsp;without&nbsp;antiquotations(simply&nbsp;remove&nbsp;the&nbsp;ant&nbsp;branch),&nbsp;&lt;/b&gt;it&nbsp;is&nbsp;a&nbsp;subtype&nbsp;of&nbsp;Ast(thanks&nbsp;to&nbsp;the&nbsp;choice&nbsp;we&nbsp;use&nbsp;variants&nbsp;here),&nbsp;&lt;b&gt;AstNA&nbsp;is&nbsp;the&nbsp;Ast&nbsp;without&nbsp;neither&nbsp;locations&nbsp;nor&nbsp;antiquotations&lt;/b&gt;),&nbsp;it&nbsp;is&nbsp;a&nbsp;subtype&nbsp;of&nbsp;AstN.&nbsp; &lt;b&gt;In&nbsp;practice,&nbsp;I&nbsp;found&nbsp;the&nbsp;Ast&nbsp;without&nbsp;locations&nbsp;is&nbsp;particular&nbsp;helpful&nbsp;when&nbsp;you&nbsp;only&nbsp;do&nbsp;the&nbsp;code&nbsp;generation,&nbsp;it&nbsp;simplifies&nbsp;this&nbsp;part&nbsp;significantly.&lt;i&gt;&lt;u&gt;&nbsp;The&nbsp;beautif&lt;/u&gt;&lt;/i&gt;&lt;/b&gt;&lt;u&gt;&lt;b&gt;&lt;i&gt;u&lt;/i&gt;&lt;/b&gt;&lt;i&nbsp;style=&quot;font-weight:bold&quot;&gt;l&nbsp;part&nbsp;is&nbsp;that&nbsp; all&nbsp;the&nbsp;four&nbsp;Ast&nbsp;share&nbsp;the&nbsp;same&nbsp;grammar&nbsp;with&nbsp;the&nbsp;same&nbsp;quosiquotatoin&nbsp;mechanism,&nbsp;as&nbsp;I&nbsp;showed&nbsp;.Fan.Lang.N.expr&nbsp;and&nbsp;.Fan.Lang.expr&lt;/i&gt;&lt;/u&gt;&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp;I&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;many&nbsp;parsers&nbsp;you&nbsp;have&nbsp;to&nbsp;maintain&nbsp;to&nbsp;reach&nbsp;such&nbsp;a&nbsp;goal&nbsp;or&nbsp;it&#39;s&nbsp;never&nbsp;going&nbsp;to&nbsp;happen.&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;Using&nbsp;variants&nbsp;to&nbsp;encode&nbsp;the&nbsp;intermediate&nbsp;ast&nbsp;has&nbsp;a&nbsp;lots&nbsp;of&nbsp;other&nbsp;benefits,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;cover&nbsp;it&nbsp;in&nbsp;such&nbsp;a&nbsp;short&nbsp;mail.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; So,&lt;b&gt;&nbsp;my&nbsp;proposal&nbsp;is&nbsp;that&nbsp;the&nbsp;community&nbsp;design&nbsp;an&nbsp;Intermediate&nbsp;Ast&nbsp;together,&nbsp;and&nbsp;write&nbsp;a&nbsp;built-in&nbsp;parser&nbsp;to&nbsp;such&nbsp;Intermediate&nbsp;Ast&nbsp;then&nbsp;dump&nbsp;to&nbsp;Parsetree,&nbsp;but&nbsp;I&nbsp;am&nbsp;for&nbsp;that&nbsp;Parsetree&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;cleaned&nbsp;a&nbsp;bit&nbsp;but&nbsp;not&nbsp;too&nbsp;much&nbsp;change&nbsp;.&nbsp; &lt;/b&gt;I&nbsp;do&nbsp;appreciate&nbsp;you&nbsp;can&nbsp;take&nbsp;something&nbsp;away&nbsp;from&nbsp;Fan,&nbsp;I&nbsp;think&nbsp;the&nbsp;Parsetree&nbsp;is&lt;b&gt;&nbsp;not&nbsp;the&nbsp;ideal&nbsp;part&lt;/b&gt;&nbsp;to&nbsp;do&nbsp;SMP,&nbsp;HTH&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;--&nbsp;Regards,&nbsp;Hongbo<br>
<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>

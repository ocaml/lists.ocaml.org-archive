<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Jan&nbsp;31,&nbsp;2013&nbsp;at&nbsp;7:54&nbsp;AM,&nbsp;Alain&nbsp;Frisch&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:alain.frisch@lexifi.com&quot;&nbsp;target=&quot;_blank&quot;&gt;alain.frisch@lexifi.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
On&nbsp;01/30/2013&nbsp;02:18&nbsp;PM,&nbsp;Hongbo&nbsp;Zhang&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Ast&nbsp;Rewriter&nbsp;is&nbsp;*bad&nbsp;*for&nbsp;arbitrary&nbsp;code&nbsp;generation,&nbsp;its&nbsp;neat&nbsp;case&nbsp;is&lt;br&gt;<br>
something&nbsp;like&nbsp;bisect.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
One&nbsp;of&nbsp;the&nbsp;most&nbsp;widely&nbsp;used&nbsp;kind&nbsp;of&nbsp;Camlp4&nbsp;extensions&nbsp;today&nbsp;is&nbsp;about&nbsp;code&nbsp;generation&nbsp;based&nbsp;on&nbsp;type&nbsp;declarations&nbsp;(plus&nbsp;some&nbsp;annotations),&nbsp;à&nbsp;la&nbsp;type-conv&nbsp;or&nbsp;deriving.&nbsp; This&nbsp;seems&nbsp;to&nbsp;be&nbsp;a&nbsp;perfect&nbsp;match&nbsp;for&nbsp;AST&nbsp;rewriters&nbsp;plus&nbsp;attributes.&nbsp; Don&#39;t&nbsp;you&nbsp;agree?&lt;/blockquote&gt;<br>
&lt;div&gt;This&nbsp;could&nbsp;have&nbsp;a&nbsp;even&nbsp;better&nbsp;solution&nbsp;(not&nbsp;global&nbsp;Ast&nbsp;rewriting)&nbsp;in&nbsp;Fan&nbsp;without&nbsp;introducing&nbsp;any&nbsp;global&nbsp;Ast&nbsp;rewriting.&lt;/div&gt;&lt;div&gt;{:ocaml|&lt;/div&gt;&lt;div&gt;type&nbsp;t&nbsp;=&nbsp;A&nbsp;of&nbsp;int&lt;/div&gt;&lt;div&gt;|}&lt;/div&gt;&lt;div&gt;{:derive|(Print,Eq,Meata,...)|}&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
And&nbsp;Ast&nbsp;Rewriter&nbsp;is&nbsp;not&nbsp;composable&nbsp;at&nbsp; all,&lt;br&gt;<br>
suppose&nbsp;you&nbsp;have&nbsp;two&nbsp;AST&nbsp;Rewriters&nbsp;A,B&nbsp;,there&nbsp;are&nbsp;no&nbsp;guarantee&nbsp;that&nbsp; A.B&lt;br&gt;<br>
==&nbsp;B.A,&nbsp;it&nbsp;just&nbsp;gives&nbsp;you&nbsp;an&nbsp;illusion&nbsp;that&nbsp;it&nbsp;works,&nbsp;probably&nbsp;it&lt;br&gt;<br>
silently&nbsp;fails.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
I&nbsp;don&#39;t&nbsp;agree.&nbsp; A&nbsp;and&nbsp;B&nbsp;are&nbsp;functions&nbsp;from&nbsp;AST&nbsp;to&nbsp;AST,&nbsp;so&nbsp;there&nbsp;is&nbsp;a&nbsp;very&nbsp;nice&nbsp;notion&nbsp;of&nbsp;composition:&nbsp;the&nbsp;composition&nbsp;of&nbsp;functions.&nbsp; It&nbsp;is&nbsp;true&nbsp;that&nbsp;A.B&nbsp;and&nbsp;B.A&nbsp;don&#39;t&nbsp;have&nbsp;the&nbsp;same&nbsp;behavior&nbsp;but&nbsp;at&nbsp;least,&nbsp;I&nbsp;can&nbsp;understand&nbsp;what&nbsp;A.B&nbsp;and&nbsp;B.A&nbsp;will&nbsp;do&nbsp;as&nbsp;soon&nbsp;as&nbsp;I&nbsp;know&nbsp;how&nbsp;A&nbsp;and&nbsp;B&nbsp;behave&nbsp;individually,&nbsp;without&nbsp;having&nbsp;to&nbsp;know&nbsp;anything&nbsp;about&nbsp;their&nbsp;implementation.&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;For&nbsp;any&nbsp;nontrivial&nbsp;Ast&nbsp;Rewriter,&nbsp;I&nbsp;totally&nbsp;get&nbsp;lost,&nbsp;maybe&nbsp;I&nbsp;am&nbsp;dumb&nbsp;and&nbsp;you&nbsp;use&nbsp;objects&nbsp;here(ast_mapper)&nbsp;suppose&nbsp;both&nbsp;ast_mapper&nbsp;try&nbsp;to&nbsp;inject&nbsp;some&nbsp;bindings&nbsp;at&nbsp;the&nbsp;beginning,&nbsp;what&nbsp;do&nbsp;you&nbsp;expect&nbsp;here?&nbsp;Besides,&nbsp;there&#39;s&nbsp;no&nbsp;reason&nbsp;that&nbsp;Ast&nbsp;Rewriter&nbsp;should&nbsp;be&nbsp;pure,&nbsp;once&nbsp;is&nbsp;impure,&nbsp;how&nbsp;shall&nbsp;I&nbsp;reason&nbsp;the&nbsp;program?&nbsp; &lt;/div&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;know&nbsp;you&nbsp;have&nbsp;projects&nbsp;to&nbsp;provide&nbsp;a&nbsp;cleaner&nbsp;functional&nbsp;API&nbsp;for&nbsp;grammars,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;how&nbsp;modifications&nbsp;of&nbsp;the&nbsp;concrete&nbsp;syntax&nbsp;can&nbsp;be&nbsp;combined,&nbsp;in&nbsp;full&nbsp;generality,&nbsp;in&nbsp;a&nbsp;predictable&nbsp;way.&nbsp; It&nbsp;seems&nbsp;you&nbsp;also&nbsp;have&nbsp;plans&nbsp;to&nbsp;get&nbsp;rid&nbsp;of&nbsp;the&nbsp;ability&nbsp;to&nbsp;modify&nbsp;the&nbsp;concrete&nbsp;syntax.&nbsp; This&nbsp;sounds&nbsp;very&nbsp;reasonable&nbsp;to&nbsp;me.&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;We&nbsp;have&nbsp;provided&nbsp;purely&nbsp;functional&nbsp;grammars&nbsp;API&nbsp;which&nbsp;helps&nbsp;a&nbsp;lot&nbsp;to&nbsp;limit&nbsp;the&nbsp;scope&nbsp;of&nbsp;the&nbsp;syntax&nbsp;extension&lt;b&gt;,&nbsp;if&nbsp;people&nbsp;don&#39;t&nbsp;like&nbsp;it,&nbsp;just&nbsp;not&nbsp;expose&nbsp;it,&nbsp;or&nbsp;write&nbsp;another&nbsp;frontend&nbsp;with&nbsp;fixed&nbsp;grammar.&lt;/b&gt;&nbsp;But&nbsp;we&nbsp;do&nbsp;have&nbsp;a&nbsp;lot&nbsp;of&nbsp;things&nbsp;that&nbsp;Ast&nbsp;Rewriter&nbsp;does&nbsp;not&nbsp;provide,&nbsp;quasiquotation(which&nbsp;I&nbsp;think&nbsp;is&nbsp;a&nbsp;&lt;b&gt;fundamental&lt;/b&gt;&nbsp;difference&nbsp;from&nbsp;ppx),&nbsp;quotation(delimited&nbsp;DSL),&nbsp;ast&nbsp;rewriter(the&nbsp;same&nbsp;as&nbsp;ppx),&nbsp;type&nbsp;hook(the&nbsp;example&nbsp;I&nbsp;gave&nbsp;before),&nbsp;lexer&nbsp;hook,&nbsp;and&nbsp;lots&nbsp;other&nbsp;stuff&lt;/div&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
 &nbsp; &nbsp;3.&nbsp;How&nbsp;do&nbsp;you&nbsp;implement&nbsp;the&nbsp;expander?&nbsp; Somehow,&nbsp;you&nbsp;need&nbsp;to&nbsp;parse&lt;br&gt;<br>
 &nbsp; &nbsp;the&nbsp;content&nbsp;of&nbsp;the&nbsp;quotation&nbsp;(stored&nbsp;as&nbsp;a&nbsp;string&nbsp;in&nbsp;the&nbsp;AST),&nbsp;which&lt;br&gt;<br>
 &nbsp; &nbsp;involves&nbsp;non&nbsp;trivial&nbsp;stuff,&nbsp;like&nbsp;a&nbsp;parser&nbsp;being&nbsp;able&nbsp;to&nbsp;parse&nbsp;OCaml&lt;br&gt;<br>
 &nbsp; &nbsp;code&nbsp;mixed&nbsp;with&nbsp;something&nbsp;else.&nbsp; Personally,&nbsp;I&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;to&lt;br&gt;<br>
 &nbsp; &nbsp;implement&nbsp;the&nbsp;quotation&nbsp;expander&nbsp;with&nbsp;the&nbsp;parsing&nbsp;technologies&nbsp;I&#39;m&lt;br&gt;<br>
 &nbsp; &nbsp;familiar&nbsp;with.&lt;br&gt;<br>
&lt;br&gt;<br>
when&nbsp;you&nbsp;design&nbsp;your&nbsp;DSL,&nbsp;the&nbsp;left&nbsp;part&nbsp;is&nbsp;pretty&nbsp;easy&nbsp;to&nbsp;parse,&nbsp;when&lt;br&gt;<br>
you&nbsp;see&nbsp;the&nbsp;delimiter&nbsp;&quot;-&gt;&quot;,&nbsp;invoking&nbsp;an&nbsp;existing&nbsp;parser.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
So&nbsp;you&nbsp;need&nbsp;to:&lt;br&gt;<br>
&lt;br&gt;<br>
 -&nbsp;Write&nbsp;a&nbsp;custom&nbsp;parser&nbsp;for&nbsp;left&nbsp;parts&nbsp;(regexps),&nbsp;which&nbsp;stops&nbsp;at&nbsp;&quot;-&gt;&quot;.&lt;br&gt;<br>
To&nbsp;write&nbsp;this&nbsp;parser,&nbsp;you&nbsp;need&nbsp;to&nbsp;use&nbsp;ocamlyacc,&nbsp;menhir,&nbsp;or&nbsp;another&nbsp;tool.&nbsp;(And&nbsp;probably&nbsp;plug&nbsp;the&nbsp;official&nbsp;OCaml&nbsp;lexer?)&lt;br&gt;<br>
 -&nbsp;Call&nbsp;the&nbsp;official(?)&nbsp;OCaml&nbsp;parser&nbsp;on&nbsp;its&nbsp;&quot;expr&quot;&nbsp;entry&nbsp;and&nbsp;hope&nbsp;that&nbsp;it&nbsp;stops&nbsp;exactly&nbsp;when&nbsp;it&nbsp;encounters&nbsp;the&nbsp;next&nbsp;&quot;|&quot;&nbsp;(does&nbsp;this&nbsp;really&nbsp;work?).&lt;br&gt;<br>
 -&nbsp;Adapt&nbsp;the&nbsp;locations&nbsp;returned&nbsp;by&nbsp;this&nbsp;parser,&nbsp;or&nbsp;be&nbsp;careful&nbsp;to&nbsp;initialize&nbsp;the&nbsp;lexbuf&nbsp;with&nbsp;locations&nbsp;that&nbsp;match&nbsp;exactly&nbsp;the&nbsp;concrete&nbsp;location&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;part&nbsp;in&nbsp;the&nbsp;original&nbsp;source&nbsp;code.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;This&nbsp;is&nbsp;&lt;b&gt;already&nbsp;implemented&nbsp;in&nbsp;Fan&nbsp;within&nbsp;tens&nbsp;of&nbsp;lines&nbsp;of&nbsp;code,&lt;/b&gt;&nbsp;you&nbsp;are&nbsp;much&nbsp;more&nbsp;experienced&nbsp;than&nbsp;me,&nbsp;so&nbsp;I&nbsp;bet&nbsp;you&nbsp;definitely&nbsp;could&nbsp;parse&nbsp;it!&nbsp;(I&nbsp;don&#39;t&nbsp;consider&nbsp;tens&nbsp;of&nbsp;lines&nbsp;of&nbsp;code&nbsp;is&nbsp;complex..&nbsp;)&nbsp;my&nbsp;taste&nbsp;shows&nbsp;that&nbsp;its&nbsp;notation&nbsp;is&nbsp;much&nbsp;more&nbsp;elegant&nbsp;than&nbsp;sedlex&nbsp;(imho)&lt;/div&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
This&nbsp;seems&nbsp;much&nbsp;more&nbsp;complex&nbsp;than&nbsp;the&nbsp;current&nbsp;implementation&nbsp;of&nbsp;sedlex&nbsp;(or&nbsp;a&nbsp;variant&nbsp;of&nbsp;it&nbsp;where&nbsp;regexps&nbsp;would&nbsp;be&nbsp;written&nbsp;with&nbsp;some&nbsp;concrete&nbsp;syntax),&nbsp;for&nbsp;no&nbsp;obvious&nbsp;benefit.&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Alain&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;--&nbsp;Regards,&nbsp;Hongbo<br>

</tt>

<tt>
&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;Dear&nbsp;all,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;I&nbsp;summarized&nbsp;some&nbsp;possible&nbsp;pitfalls&nbsp;people&nbsp;may&nbsp;encounter&nbsp;here(Ast&nbsp;Rewriter&nbsp;is&nbsp;also&nbsp;freely&nbsp;available &lt;/div&gt;&lt;div&gt;in&nbsp;Fan&nbsp;but&nbsp;used&nbsp;only&nbsp;in&nbsp;some&nbsp;areas&nbsp;similar&nbsp;to&nbsp; &lt;b&gt;bisect&lt;/b&gt;):&lt;/div&gt;<br>
&lt;div&gt; &nbsp;  &lt;/div&gt;&lt;div&gt;&lt;i&gt; &lt;/i&gt;&nbsp; &nbsp;1.&nbsp;composition&nbsp;semantics&nbsp;unclear&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;suppose&nbsp;we&nbsp;have&nbsp;three&nbsp;plugins&nbsp;A,&nbsp;B,&nbsp;C&nbsp; which&nbsp;does&nbsp;the&nbsp;Ast&nbsp;rewriting.&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;What&#39;s&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;composition&nbsp;A.B.C&nbsp; and&nbsp;B.C.A?&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Suppose&nbsp;A&nbsp;a&nbsp;very&nbsp;naive&nbsp;plugin&nbsp;to&nbsp;remove&nbsp;all&nbsp;the&nbsp;unsafe&nbsp;expression,&nbsp;but&nbsp;B&nbsp;happens&nbsp;to &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;introduces&nbsp;an&nbsp;unsafe&nbsp;expression?&nbsp;What&nbsp;should&nbsp;we&nbsp;expect&nbsp;here?&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;2.&nbsp;compiling&nbsp;performance&nbsp;downgrading&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; so&nbsp;far,&nbsp;Ast&nbsp;Rewriter&nbsp;is&nbsp;always&nbsp;doing&nbsp;global&nbsp;ast&nbsp;transformation&nbsp;which&nbsp;does&nbsp;a&nbsp;lot&nbsp;of&nbsp;un-necessary&nbsp;transformation, &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; suppose&nbsp;you&nbsp;have&nbsp;a&nbsp;series&nbsp;of&nbsp;plugins&nbsp;which&nbsp;does&nbsp;global&nbsp;transformation&nbsp;?&nbsp;Maybe&nbsp;it&nbsp;could&nbsp;be&nbsp;improved,&nbsp;but&nbsp;I&nbsp;don&#39;t&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; see&nbsp;a&nbsp;clever&nbsp;way&nbsp;to&nbsp;fuse&nbsp;plugins.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;3.&nbsp;inconsistent&nbsp;semantics&nbsp;between&nbsp;compiling&nbsp;and&nbsp;toplevel&nbsp;module &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;we&nbsp;could&nbsp;also&nbsp;do&nbsp;the&nbsp;Ast&nbsp;transformation&nbsp;in&nbsp;the&nbsp;toplevel,&nbsp;but&nbsp;the&nbsp;semantics&nbsp;is&nbsp;a&nbsp;bit&nbsp;different,&nbsp;this&nbsp;is&nbsp;also&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;that&nbsp;we&nbsp;are&nbsp;doing&nbsp;global&nbsp;transformation&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;4.&nbsp;upgrading&nbsp;compatibility &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;I&nbsp;suggest&nbsp;introducing&nbsp;an&nbsp;Intermediate&nbsp;Ast&nbsp;(for&nbsp;lots&nbsp;of&nbsp;good&nbsp;reasons&nbsp;I&nbsp;ever&nbsp;mentioned),&nbsp;if&nbsp;we&nbsp;*expose*&nbsp;too&nbsp;much&nbsp;compiler&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;API,&nbsp;any&nbsp;change&nbsp;will&nbsp;break&nbsp;all&nbsp;existing&nbsp;plugins.&nbsp;Even&nbsp;though&nbsp;you&nbsp;use&nbsp;some&nbsp;nice&nbsp;utility&nbsp;like&nbsp;ast_mapper,&nbsp;people&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;still&nbsp;use&nbsp;the&nbsp;Constructor&nbsp;name&nbsp;explicitly.&nbsp;  &lt;/div&gt;--&nbsp;&lt;br&gt;--&nbsp;Regards,&nbsp;Hongbo<br>

</tt>

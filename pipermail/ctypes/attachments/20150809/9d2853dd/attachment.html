<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello—&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;Jeremy&nbsp;for&nbsp;this&nbsp;response.&nbsp;After&nbsp;some&nbsp;time&nbsp;I&#39;ve&nbsp;been&nbsp;able&nbsp;to&nbsp;come&nbsp;back&nbsp;and&nbsp;try&nbsp;these&nbsp;things&nbsp;out.&nbsp;I&nbsp;do&nbsp;have&nbsp;some&nbsp;new&nbsp;questions&nbsp;:)&nbsp;I&nbsp;might&nbsp;write&nbsp;this&nbsp;out&nbsp;a&nbsp;little&nbsp;more&nbsp;verbosely&nbsp;than&nbsp;I&nbsp;need&nbsp;to&nbsp;just&nbsp;to&nbsp;be&nbsp;certain&nbsp;I&#39;m&nbsp;speaking&nbsp;precisely.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;test&nbsp;program&nbsp;with&nbsp;a&nbsp;c&nbsp;function&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp; &nbsp;int&nbsp;increment3(int&nbsp;x)&nbsp;{&nbsp;return&nbsp;x&nbsp;+&nbsp;3;&nbsp;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;the&nbsp;OCaml&nbsp;side,&nbsp;this&nbsp;is&nbsp;accessed&nbsp;as&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;let&nbsp;increment3&nbsp;=&nbsp;foreign&nbsp;&quot;increment3&quot;&nbsp;(int&nbsp;@-&gt;&nbsp;returning&nbsp;int)&nbsp;in&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;increment3&nbsp;3&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;that&nbsp;works&nbsp;and&nbsp;I&#39;m&nbsp;happy&nbsp;with&nbsp;it.&nbsp;Actually,&nbsp;after&nbsp;playing&nbsp;with&nbsp;the&nbsp;foreign&nbsp;/&nbsp;&quot;@-&gt;&quot;&nbsp;interface,&nbsp;I&#39;m&nbsp;finding&nbsp;it&nbsp;seems&nbsp;to&nbsp;be&nbsp;about&nbsp;as&nbsp;good&nbsp;as&nbsp;I&nbsp;need,&nbsp;and&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;if&nbsp;I&nbsp;can&nbsp;use&nbsp;that&nbsp;instead&nbsp;of&nbsp;having&nbsp;to&nbsp;work&nbsp;with&nbsp;the&nbsp;low-level&nbsp;interfaces&nbsp;(which&nbsp;as&nbsp;discussed&nbsp;before&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;directly&nbsp;exposed&nbsp;at&nbsp;this&nbsp;time&nbsp;anyway).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Anyway,&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;set&nbsp;up&nbsp;my&nbsp;OCaml-implemented&nbsp;interpreter,&nbsp;so&nbsp;that&nbsp;this&nbsp;line&nbsp;of&nbsp;code&nbsp;in&nbsp;Emily&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;&quot;let&nbsp;increment3&quot;&nbsp;above:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;(*&nbsp;Just&nbsp;pretend&nbsp;.int&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;&quot;int&quot;&nbsp;*)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;increment3&nbsp;=&nbsp;package.emily.ffi.c.function&nbsp;[&nbsp;name&nbsp;=&nbsp;.increment3;&nbsp;args&nbsp;=&nbsp;[&nbsp;.int,&nbsp;];&nbsp;return&nbsp;=&nbsp;.int&nbsp;]&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;syntax&nbsp;could&nbsp;use&nbsp;some&nbsp;work&nbsp;:P&nbsp;But&nbsp;never&nbsp;mind&nbsp;that.&nbsp;I&#39;ve&nbsp;so&nbsp;far&nbsp;got&nbsp;it&nbsp;where&nbsp;when&nbsp;you&nbsp;invoke&nbsp;ffi.c.function,&nbsp;the&nbsp;function&nbsp;specification&nbsp;you&nbsp;provided&nbsp;gets&nbsp;piped&nbsp;into&nbsp;OCaml&nbsp;and&nbsp;turned&nbsp;into&nbsp;this&nbsp;OCaml&nbsp;data&nbsp;structure:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp; &nbsp;type&nbsp;foreignSpec&nbsp;=&nbsp;{&nbsp;name&nbsp;:&nbsp;string;&nbsp;args&nbsp;:&nbsp;string&nbsp;list;&nbsp;returning:&nbsp;string;&nbsp;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;seems&nbsp;like&nbsp;a&nbsp;straightforward&nbsp;representation&nbsp;of&nbsp;the&nbsp;information&nbsp;@-&gt;&nbsp;encodes;&nbsp;it&nbsp;seems&nbsp;something&nbsp;parsing&nbsp;a&nbsp;header&nbsp;would&nbsp;need&nbsp;to&nbsp;represent&nbsp;the&nbsp;data&nbsp;the&nbsp;same&nbsp;way.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;naive&nbsp;impulse&nbsp;is&nbsp;to&nbsp;imagine&nbsp;that&nbsp;this&nbsp;is&nbsp;straightforward,&nbsp;and&nbsp;I&nbsp;need&nbsp;to&nbsp;just&nbsp;build&nbsp;up&nbsp;a&nbsp;typ&nbsp;variable&nbsp;by&nbsp;repeatedly&nbsp;chaining&nbsp;@-&gt;,&nbsp;something&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;let&nbsp;typeConvert&nbsp;=&nbsp;function&nbsp;&quot;void&quot;&nbsp;-&gt;&nbsp;void&nbsp;|&nbsp;&quot;int&quot;&nbsp;-&gt;&nbsp;int&nbsp;|&nbsp;_&nbsp;-&gt;&nbsp;failwith&nbsp;&quot;??&quot;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;  let&nbsp;functionFrom&nbsp;spec&nbsp;=&lt;/div&gt;&lt;div&gt; &nbsp;   &nbsp; &nbsp;foreign&nbsp;&lt;a&nbsp;href=&quot;http://spec.name&quot;&gt;spec.name&lt;/a&gt;&nbsp;(&nbsp;List.fold_right&lt;/div&gt;&lt;div&gt; &nbsp;   &nbsp; &nbsp; &nbsp; &nbsp;(&nbsp;@-&gt;&nbsp;)&lt;/div&gt;&lt;div&gt; &nbsp;   &nbsp;   &nbsp; &nbsp;(&nbsp;List.map&nbsp;typeConvert&nbsp;wrap.args&nbsp;)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;   &nbsp;  (&nbsp;returning&nbsp;(&nbsp;typeConvert&nbsp;wrap.returning&nbsp;)&nbsp;)&nbsp;)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;I&nbsp;start&nbsp;trying&nbsp;to&nbsp;implement&nbsp;this,&nbsp;OCaml&nbsp;immediately&nbsp;objects&nbsp;that&nbsp;even&nbsp;just&nbsp;typeConvert&nbsp;is&nbsp;impossible&nbsp;to&nbsp;compile:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp; &nbsp;Error:&nbsp;This&nbsp;expression&nbsp;has&nbsp;type&nbsp;int&nbsp;Ctypes.typ&nbsp;=&nbsp;int&nbsp;Ctypes_static.typ&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; but&nbsp;an&nbsp;expression&nbsp;was&nbsp;expected&nbsp;of&nbsp;type&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unit&nbsp;Ctypes.typ&nbsp;=&nbsp;unit&nbsp;Ctypes_static.typ&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type&nbsp;int&nbsp;is&nbsp;not&nbsp;compatible&nbsp;with&nbsp;type&nbsp;unit &lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;seems&nbsp;to&nbsp;make&nbsp;immediate&nbsp;sense:&nbsp;I&nbsp;don&#39;t&nbsp;fully&nbsp;understand&nbsp;what&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;thing&nbsp;@-&gt;&nbsp;returns&nbsp;is&nbsp;(Merlin&nbsp;says&nbsp;it&#39;s &#39;_a&nbsp;-&gt;&nbsp;&#39;_b&nbsp;-&gt;&nbsp;&#39;_c&nbsp;...)&nbsp;but&nbsp;it&nbsp;seems&nbsp;like&nbsp;whatever&nbsp;@-&gt;&nbsp;may&nbsp;be&nbsp;doing,&nbsp;in&nbsp;all&nbsp;cases&nbsp;@-&gt;&nbsp;or&nbsp;foreign&nbsp;actually&nbsp;gets&nbsp;used,&nbsp;the&nbsp;type&nbsp;of&nbsp;that&nbsp;@-&gt;&#39;s&nbsp;return&nbsp;must&nbsp;be&nbsp;something&nbsp;known&nbsp;at&nbsp;the&nbsp;call&nbsp;site&nbsp;at&nbsp;compile&nbsp;time--&nbsp;because&nbsp;when&nbsp;OCaml&nbsp;code&nbsp;invokes&nbsp;&quot;foreign&quot;&nbsp;OCaml&nbsp;will&nbsp;need&nbsp;to&nbsp;statically&nbsp;compile&nbsp;a&nbsp;statically&nbsp;typed&nbsp;result.&nbsp;So&nbsp;I&nbsp;can&#39;t&nbsp;possibly&nbsp;store&nbsp;one&nbsp;of&nbsp;the&nbsp;typs&nbsp;in&nbsp;a&nbsp;variable&nbsp;which&nbsp;could&nbsp;contain&nbsp;sometimes&nbsp;&quot;int&quot;&nbsp;and&nbsp;sometimes&nbsp;&quot;void&quot;.&nbsp;I&#39;m&nbsp;assuming&nbsp;this&nbsp;works&nbsp;something&nbsp;like&nbsp;C++&nbsp;template&nbsp;arguments,&nbsp;which&nbsp;are&nbsp;something&nbsp;I&nbsp;have&nbsp;a&nbsp;little&nbsp;more&nbsp;familiarity&nbsp;with&nbsp;than&nbsp;OCaml&nbsp;type&nbsp;variables.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;like,&nbsp;if&nbsp;I&nbsp;really&nbsp;understood&nbsp;what&nbsp;@-&gt;&nbsp;is&nbsp;doing,&nbsp;I&nbsp;might&nbsp;be&nbsp;able&nbsp;to&nbsp;maybe&nbsp;make&nbsp;this&nbsp;work&nbsp;anyway.&nbsp;In&nbsp;Emily&nbsp;I&nbsp;currently&nbsp;have&nbsp;only&nbsp;one&nbsp;&quot;type&quot;,&nbsp;a&nbsp;big&nbsp;variant&nbsp;which&nbsp;is&nbsp;modeled&nbsp;in&nbsp;OCaml&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;type&nbsp;value&nbsp;=&nbsp;Null&nbsp;|&nbsp;True&nbsp;|&nbsp;FloatValue&nbsp;of&nbsp;float&nbsp;|&nbsp;StringValue&nbsp;of&nbsp;string&nbsp;|&nbsp;AtomValue&nbsp;of&nbsp;string&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;|&nbsp;BuiltinFunctionValue&nbsp;of&nbsp;(value&nbsp;-&gt;&nbsp;value)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;eventually&nbsp;intend&nbsp;for&nbsp;the&nbsp;ffi.c.function&nbsp;implementation&nbsp;to&nbsp;return&nbsp;a&nbsp;BuiltinFunctionValue&nbsp;that&nbsp;takes&nbsp;an&nbsp;argument;&nbsp;either&nbsp;unpacks&nbsp;it&nbsp;from&nbsp;a&nbsp;&quot;value&quot;&nbsp;into&nbsp;the&nbsp;correct&nbsp;tagged&nbsp;type&nbsp;or&nbsp;throws&nbsp;an&nbsp;error;&nbsp;then&nbsp;packs&nbsp;the&nbsp;return&nbsp;back&nbsp;into&nbsp;an&nbsp;appropriately&nbsp;tagged&nbsp;&quot;value&quot;.&nbsp;The&nbsp;&quot;value&quot;&nbsp;pack&nbsp;and&nbsp;unpack&nbsp;functions&nbsp;will&nbsp;know&nbsp;their&nbsp;types&nbsp;statically,&nbsp;so&nbsp;maybe&nbsp;in&nbsp;principle&nbsp;they&nbsp;can&nbsp;work&nbsp;in&nbsp;participation&nbsp;with&nbsp;whatever&nbsp;type-chaining&nbsp;trick&nbsp;@-&gt;&nbsp;does&nbsp;and&nbsp;still&nbsp;produce&nbsp;well-typed&nbsp;code.&nbsp;But&nbsp;it&#39;s&nbsp;very&nbsp;unclear&nbsp;to&nbsp;me&nbsp;how&nbsp;to&nbsp;get&nbsp;started&nbsp;with&nbsp;that,&nbsp;or&nbsp;whether&nbsp;it&nbsp;will&nbsp;ultimately&nbsp;work.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Do&nbsp;you&nbsp;have&nbsp;any&nbsp;thoughts&nbsp;on&nbsp;this?&nbsp;Is&nbsp;this&nbsp;approach&nbsp;(engaging&nbsp;foreign&nbsp;/&nbsp;@-&gt;&nbsp;directly)&nbsp;one&nbsp;which&nbsp;can&nbsp;eventually&nbsp;work,&nbsp;or&nbsp;should&nbsp;I&nbsp;back&nbsp;off&nbsp;and&nbsp;attempt&nbsp;one&nbsp;of&nbsp;the&nbsp;lower-level&nbsp;approaches&nbsp;mentioned&nbsp;in&nbsp;your&nbsp;previous&nbsp;email?&nbsp;Your&nbsp;previous&nbsp;email&nbsp;proposed&nbsp;building&nbsp;out&nbsp;a &lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:12.8000001907349px&quot;&gt;Ctypes_untyped&nbsp;with&nbsp;a&nbsp;slightly&nbsp;different&nbsp;interface,&nbsp;but&nbsp;it&nbsp;was&nbsp;not&nbsp;clear&nbsp;to&nbsp;me&nbsp;what&nbsp;implementation&nbsp;of&nbsp;that&nbsp;would&nbsp;look&nbsp;like.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:12.8000001907349px&quot;&gt;Thanks!&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:12.8000001907349px&quot;&gt; -&nbsp;Andi&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Jun&nbsp;29,&nbsp;2015&nbsp;at&nbsp;4:16&nbsp;PM,&nbsp;Jeremy&nbsp;Yallop&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:yallop@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;yallop@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi&nbsp;Andi,&lt;br&gt;<br>
&lt;br&gt;<br>
Please&nbsp;excuse&nbsp;the&nbsp;slow&nbsp;response.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
On&nbsp;27&nbsp;June&nbsp;2015&nbsp;at&nbsp;14:25,&nbsp;Andi&nbsp;McClure&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:andi.m.mcclure@gmail.com&quot;&gt;andi.m.mcclure@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hello,&nbsp;I&nbsp;have&nbsp;a&nbsp;project&nbsp;which&nbsp;is&nbsp;a&nbsp;programming&nbsp;language&nbsp;(&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://emilylang.org/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://emilylang.org/&lt;/a&gt;&nbsp;)&nbsp;and&nbsp;the&nbsp;current&nbsp;interpreter&nbsp;is&nbsp;implemented&nbsp;in&nbsp;ocaml.&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;want&nbsp;to&nbsp;add&nbsp;a&nbsp;C&nbsp;FFI,&nbsp;and&nbsp;I&nbsp;am&nbsp;looking&nbsp;at&nbsp;ocaml-ctypes,&nbsp;but&nbsp;I&nbsp;am&nbsp;having&lt;br&gt;<br>
&gt;&nbsp;trouble&nbsp;figuring&nbsp;out&nbsp;how&nbsp;best&nbsp;to&nbsp;use&nbsp;the&nbsp;ocaml-ctypes&nbsp;library&nbsp;given&nbsp;my&lt;br&gt;<br>
&gt;&nbsp;project&#39;s&nbsp;specific&nbsp;needs&nbsp;as&nbsp;a&nbsp;language.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Well,&nbsp;using&nbsp;ocaml-ctypes&nbsp;to&nbsp;build&nbsp;an&nbsp;FFI&nbsp;for&nbsp;another&nbsp;language&nbsp;is&nbsp;a&nbsp;bit&lt;br&gt;<br>
different&nbsp;from&nbsp;the&nbsp;usual&nbsp;use&nbsp;case&nbsp;of&nbsp;exposing&nbsp;a&nbsp;particular&nbsp;C&nbsp;library&lt;br&gt;<br>
to&nbsp;OCaml,&nbsp;so&nbsp;it&#39;ll&nbsp;be&nbsp;interesting&nbsp;to&nbsp;see&nbsp;how&nbsp;things&nbsp;turn&nbsp;out.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;Basically:&nbsp;ocaml-ctypes&nbsp;seems&nbsp;to&nbsp;take&nbsp;libFFI&nbsp;and&nbsp;recast&nbsp;its&nbsp;operations&nbsp;in&lt;br&gt;<br>
&gt;&nbsp;terms&nbsp;of&nbsp;ocaml&nbsp;idioms&nbsp;and&nbsp;primitives.&nbsp;This&nbsp;looks&nbsp;great&nbsp;if&nbsp;I&nbsp;am&nbsp;writing&nbsp;an&lt;br&gt;<br>
&gt;&nbsp;ocaml&nbsp;program.&nbsp;However,&nbsp;my&nbsp;goal&nbsp;is&nbsp;to&nbsp;present&nbsp;an&nbsp;interface&nbsp;to&nbsp;libffi&nbsp;(or&lt;br&gt;<br>
&gt;&nbsp;something&nbsp;like&nbsp;it)&nbsp;in&nbsp;terms&nbsp;of&nbsp;*Emily*&nbsp;idioms&nbsp;and&nbsp;primitives&nbsp;(Emily&nbsp;being&nbsp;my&lt;br&gt;<br>
&gt;&nbsp;language)&nbsp;so&nbsp;that&nbsp;I&nbsp;can&nbsp;write&nbsp;an&nbsp;Emily&nbsp;program.&nbsp;This&nbsp;means&nbsp;directly&nbsp;wrapping&lt;br&gt;<br>
&gt;&nbsp;ocaml-ctypes&nbsp;probably&nbsp;won&#39;t&nbsp;work&nbsp;out&nbsp;well&nbsp;(the&nbsp;ocaml&nbsp;idioms&nbsp;ocaml-ctypes&lt;br&gt;<br>
&gt;&nbsp;uses&nbsp;can&#39;t&nbsp;all&nbsp;be&nbsp;directly&nbsp;represented&nbsp;in&nbsp;my&nbsp;language,&nbsp;and&nbsp;they&nbsp;might&nbsp;come&lt;br&gt;<br>
&gt;&nbsp;across&nbsp;as&nbsp;weird&nbsp;to&nbsp;the&nbsp;language&nbsp;users&nbsp;who&nbsp;are&nbsp;probably&nbsp;not&nbsp;ocaml&nbsp;users).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;My&nbsp;initial&nbsp;thought&nbsp;was&nbsp;that&nbsp;what&nbsp;I&nbsp;probably&nbsp;wanted&nbsp;to&nbsp;do&nbsp;was&nbsp;try&nbsp;to&nbsp;present&lt;br&gt;<br>
&gt;&nbsp;an&nbsp;interface&nbsp;between&nbsp;the&nbsp;interpreter&nbsp;and&nbsp;interpreted&nbsp;code&nbsp;that&nbsp;closely&lt;br&gt;<br>
&gt;&nbsp;tracks&nbsp;the&nbsp;programming&nbsp;interface&nbsp;of&nbsp;libffi.&nbsp;Then&nbsp;I&nbsp;could&nbsp;write&nbsp;an&lt;br&gt;<br>
&gt;&nbsp;in-language&nbsp;library&nbsp;on&nbsp;top&nbsp;of&nbsp;this&nbsp;with&nbsp;a&nbsp;friendlier/more&nbsp;idiomatic&lt;br&gt;<br>
&gt;&nbsp;interface.&nbsp;(The&nbsp;reason&nbsp;I&nbsp;believe&nbsp;I&nbsp;want&nbsp;the&nbsp;interpreter-interpreted&lt;br&gt;<br>
&gt;&nbsp;interface&nbsp;to&nbsp;resemble&nbsp;libffi&nbsp;is&nbsp;that&nbsp;I&nbsp;might&nbsp;someday&nbsp;switch&nbsp;from&nbsp;ocaml&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;another&nbsp;language,&nbsp;and&nbsp;libffi&nbsp;will&nbsp;probably&nbsp;be&nbsp;available&nbsp;in&nbsp;other&nbsp;contexts&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;ocaml-ctypes&nbsp;will&nbsp;not).&nbsp;Looking&nbsp;over&nbsp;the&nbsp;ctypes&nbsp;code&nbsp;it&nbsp;looked&nbsp;like&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;&quot;raw&quot;&nbsp;libffi-flavored&nbsp;interface&nbsp;might&nbsp;be&nbsp;possible&nbsp;using&lt;br&gt;<br>
&gt;&nbsp;ctypes-foreign-base/ctypes_ffi.mli&nbsp;and&nbsp;the&nbsp;function_of_pointer&nbsp;interface,&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;it&nbsp;looks&nbsp;like&nbsp;this&nbsp;mli&nbsp;is&nbsp;present&nbsp;in&nbsp;the&nbsp;code&nbsp;but&nbsp;not&nbsp;exposed&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;opam&nbsp;package.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Right:&nbsp;that&nbsp;module&nbsp;is&nbsp;intended&nbsp;to&nbsp;be&nbsp;internal-only. &nbsp;However,&nbsp;some&nbsp;of&lt;br&gt;<br>
the&nbsp;functionality&nbsp;is&nbsp;expressible&nbsp;via&nbsp;the&nbsp;public&nbsp;interface. &nbsp;For&lt;br&gt;<br>
example,&nbsp;here&nbsp;are&nbsp;alternative&nbsp;implementations&nbsp;of&nbsp;function_of_pointer&lt;br&gt;<br>
and&nbsp;pointer_of_function&nbsp;using&nbsp;only&nbsp;functions&nbsp;that&nbsp;are&nbsp;currently&lt;br&gt;<br>
publicly&nbsp;exposed:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;let&nbsp;function_of_pointer&nbsp;?name&nbsp;~abi&nbsp;~check_errno&nbsp;~release_runtime_lock&nbsp;fn&nbsp;p&nbsp;=&lt;br&gt;<br>
 &nbsp; &nbsp;Ctypes.coerce&nbsp;(ptr&nbsp;void)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp;(Foreign.funptr&nbsp;?name&nbsp;~abi&nbsp;~check_errno&lt;br&gt;<br>
~runtime_lock:release_runtime_lock&nbsp;fn)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp;p&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;let&nbsp;pointer_of_function&nbsp;~abi&nbsp;~acquire_runtime_lock&nbsp;fn&nbsp;f&nbsp;=&lt;br&gt;<br>
 &nbsp; &nbsp;Ctypes.coerce&nbsp;(Foreign.funptr&nbsp;~abi&nbsp;~runtime_lock:acquire_runtime_lock&nbsp;fn)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp;(ptr&nbsp;void)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp;f&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;would&nbsp;you&nbsp;recommend&nbsp;in&nbsp;this&nbsp;case?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;can&nbsp;think&nbsp;of&nbsp;three&nbsp;approaches&nbsp;that&nbsp;are&nbsp;not&nbsp;obviously&nbsp;wrong,&nbsp;and&nbsp;it&#39;s&lt;br&gt;<br>
likely&nbsp;that&nbsp;there&nbsp;are&nbsp;others.&lt;br&gt;<br>
&lt;br&gt;<br>
First,&nbsp;you&nbsp;might&nbsp;do&nbsp;what&nbsp;you&#39;ve&nbsp;been&nbsp;considering&nbsp;already&nbsp;--&nbsp;i.e.&nbsp;using&lt;br&gt;<br>
the&nbsp;low-level&nbsp;parts&nbsp;of&nbsp;ctypes&nbsp;as&nbsp;a&nbsp;basis&nbsp;for&nbsp;a&nbsp;more&nbsp;Emily-flavoured&lt;br&gt;<br>
libffi&nbsp;binding. &nbsp;The&nbsp;two&nbsp;essential&nbsp;modules&nbsp;are&nbsp;probably&lt;br&gt;<br>
Ctypes_memory_stubs&nbsp;(src/ctypes/&lt;a&nbsp;href=&quot;http://ctypes_memory_stubs.ml&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;ctypes_memory_stubs.ml&lt;/a&gt;),&nbsp;which&lt;br&gt;<br>
provides&nbsp;an&nbsp;untyped&nbsp;API&nbsp;for&nbsp;accessing&nbsp;C-managed&nbsp;memory,&nbsp;and&lt;br&gt;<br>
Ctypes_ffi_stubs&nbsp;(src/ctypes-foreign-base/&lt;a&nbsp;href=&quot;http://ctypes_ffi_stubs.ml&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;ctypes_ffi_stubs.ml&lt;/a&gt;),&nbsp;which&lt;br&gt;<br>
provides&nbsp;a&nbsp;fairly&nbsp;direct&nbsp;OCaml&nbsp;binding&nbsp;onto&nbsp;libffi. &nbsp;Neither&nbsp;of&nbsp;these&lt;br&gt;<br>
modules&nbsp;is&nbsp;exposed&nbsp;directly,&nbsp;but&nbsp;it&nbsp;should&nbsp;be&nbsp;reasonably&lt;br&gt;<br>
straightforward&nbsp;to&nbsp;make&nbsp;them&nbsp;available&nbsp;by&nbsp;tweaking&nbsp;the&nbsp;Makefile&nbsp;to&nbsp;add&lt;br&gt;<br>
them&nbsp;to&nbsp;the&nbsp;appropriate&nbsp;&#39;.public&#39;&nbsp;list.&lt;br&gt;<br>
&lt;br&gt;<br>
Second,&nbsp;you&nbsp;might&nbsp;find&nbsp;some&nbsp;way&nbsp;to&nbsp;massage&nbsp;the&nbsp;ctypes&nbsp;API&nbsp;into&nbsp;a&nbsp;form&lt;br&gt;<br>
that&#39;s&nbsp;more&nbsp;suitable&nbsp;for&nbsp;use&nbsp;in&nbsp;Emily. &nbsp;For&nbsp;example,&nbsp;I&nbsp;can&nbsp;imagine&nbsp;the&lt;br&gt;<br>
type&nbsp;parameters&nbsp;causing&nbsp;problems&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;type&lt;br&gt;<br>
representations&nbsp;(for&nbsp;int,&nbsp;float,&nbsp;etc.)&nbsp;in&nbsp;a&nbsp;more&nbsp;uniform&nbsp;way. &nbsp;It&lt;br&gt;<br>
probably&nbsp;wouldn&#39;t&nbsp;be&nbsp;too&nbsp;much&nbsp;work&nbsp;to&nbsp;build&nbsp;an&nbsp;&#39;untyped&#39;&nbsp;interface&nbsp;on&lt;br&gt;<br>
top&nbsp;of&nbsp;ctypes&nbsp;along&nbsp;the&nbsp;following&nbsp;lines&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;module&nbsp;Ctypes_untyped&nbsp;:&lt;br&gt;<br>
 &nbsp;sig&lt;br&gt;<br>
 &nbsp; &nbsp;type&nbsp;typ&lt;br&gt;<br>
 &nbsp; &nbsp;val&nbsp;int&nbsp;:&nbsp;typ&lt;br&gt;<br>
 &nbsp; &nbsp;val&nbsp;float&nbsp;:&nbsp;typ&lt;br&gt;<br>
 &nbsp; &nbsp;val&nbsp;(@-&gt;)&nbsp;: &nbsp;typ&nbsp;-&gt;&nbsp;typ&nbsp;-&gt;&nbsp;typ&lt;br&gt;<br>
 &nbsp; &nbsp;(*&nbsp;...&nbsp;*)&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;just&nbsp;a&nbsp;guess,&nbsp;of&nbsp;course,&nbsp;and&nbsp;perhaps&nbsp;there&nbsp;are&nbsp;other&nbsp;OCaml&lt;br&gt;<br>
idioms&nbsp;that&nbsp;aren&#39;t&nbsp;so&nbsp;easy&nbsp;to&nbsp;factor&nbsp;out.&lt;br&gt;<br>
&lt;br&gt;<br>
Finally,&nbsp;you&nbsp;might&nbsp;use&nbsp;ctypes&nbsp;to&nbsp;build&nbsp;a&nbsp;binding&nbsp;to&nbsp;libffi&nbsp;--&nbsp;i.e.&lt;br&gt;<br>
just&nbsp;treat&nbsp;libffi&nbsp;like&nbsp;any&nbsp;other&nbsp;C&nbsp;library&nbsp;and&nbsp;describe&nbsp;its&nbsp;interface&lt;br&gt;<br>
using&nbsp;ctypes,&nbsp;ignoring&nbsp;the&nbsp;fact&nbsp;that&nbsp;ctypes&nbsp;uses&nbsp;libffi&nbsp;internally.&lt;br&gt;<br>
This&nbsp;approach&nbsp;isn&#39;t&nbsp;as&nbsp;absurd&nbsp;as&nbsp;it&nbsp;might&nbsp;sound&nbsp;at&nbsp;first,&nbsp;since&nbsp;recent&lt;br&gt;<br>
versions&nbsp;of&nbsp;ctypes&nbsp;make&nbsp;it&nbsp;possible&nbsp;to&nbsp;bind&nbsp;to&nbsp;C&nbsp;libraries&nbsp;by&lt;br&gt;<br>
generating&nbsp;C&nbsp;and&nbsp;OCaml&nbsp;code&nbsp;rather&nbsp;than&nbsp;by&nbsp;routing&nbsp;calls&nbsp;through&lt;br&gt;<br>
libffi,&nbsp;so&nbsp;you&nbsp;wouldn&#39;t&nbsp;necessarily&nbsp;end&nbsp;up&nbsp;using&nbsp;libffi&nbsp;twice.&lt;br&gt;<br>
&lt;br&gt;<br>
Feel&nbsp;free&nbsp;to&nbsp;ask&nbsp;if&nbsp;you&#39;d&nbsp;like&nbsp;more&nbsp;detail&nbsp;on&nbsp;any&nbsp;of&nbsp;the&nbsp;above!&lt;br&gt;<br>
&lt;br&gt;<br>
Kind&nbsp;regards,&lt;br&gt;<br>
&lt;br&gt;<br>
Jeremy.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>

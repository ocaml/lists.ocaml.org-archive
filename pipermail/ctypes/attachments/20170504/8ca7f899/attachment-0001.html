<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hello,&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&#39;m&nbsp;write&nbsp;program&nbsp;which&nbsp;uses&nbsp;C&nbsp;library&nbsp;with&nbsp;main&nbsp;event&nbsp;loop.&nbsp;So,&nbsp;I&nbsp;call&nbsp;init&nbsp;function&nbsp;of&nbsp;this&nbsp;library&nbsp;from&nbsp;ocaml&nbsp;code,&nbsp;register&nbsp;callback&nbsp;and&nbsp;call&nbsp;main&nbsp;loop&nbsp;of&nbsp;this&nbsp;library.&nbsp;After&nbsp;that&nbsp;monent,&nbsp;ocaml&nbsp;code&nbsp;will&nbsp;be&nbsp;called&nbsp;only&nbsp;from&nbsp;this&nbsp;library.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&nbsp;is&nbsp;some&nbsp;relevant&nbsp;lines&nbsp;of&nbsp;code:&lt;br&gt;&lt;br&gt;let&nbsp;bus_handler&nbsp;=&nbsp;ptr&nbsp;void&nbsp;@-&gt;&nbsp;size_t&nbsp;@-&gt;&nbsp;ptr&nbsp;(ptr&nbsp;void)&nbsp;@-&gt;&nbsp;ptr&nbsp;size_t&nbsp;@-&gt;&nbsp;returning&nbsp;int&lt;br&gt;&lt;br&gt;type&nbsp;handlers&lt;br&gt;let&nbsp;handlers:&nbsp;handlers&nbsp;structure&nbsp;typ&nbsp;=&nbsp;structure&nbsp;&quot;handlers_t&quot;&lt;br&gt;&lt;br&gt;let&nbsp;topic_name&nbsp;=&nbsp;field&nbsp;handlers&nbsp;&quot;topic_name&quot;&nbsp;string&lt;br&gt;let&nbsp;topic_handler&nbsp;=&nbsp;field&nbsp;handlers&nbsp;&quot;topic_handler&quot;&nbsp;(funptr&nbsp;~thread_registration:true&nbsp;bus_handler)&lt;br&gt;let&nbsp;topic_type&nbsp;=&nbsp;field&nbsp;handlers&nbsp;&quot;topic_type&quot;&nbsp;int&lt;br&gt;let&nbsp;()&nbsp;=&nbsp;seal&nbsp;handlers&lt;br&gt;&lt;br&gt;let&nbsp;bus_init&nbsp;=&nbsp;foreign&nbsp;&quot;bus_init&quot;&nbsp;(int&nbsp;@-&gt;&nbsp;ptr&nbsp;(ptr&nbsp;void)&nbsp;@-&gt;&nbsp;returning&nbsp;int)&lt;br&gt;let&nbsp;loop&nbsp;=&nbsp;foreign&nbsp;&quot;loop&quot;&nbsp;(ptr&nbsp;void&nbsp;@-&gt;&nbsp;returning&nbsp;int)&lt;br&gt;let&nbsp;register_server&nbsp;=&nbsp;foreign&nbsp;&quot;register_server&quot;&nbsp;(ptr&nbsp;void&nbsp;@-&gt;&nbsp;string&nbsp;@-&gt;&nbsp;ptr&nbsp;handlers&nbsp;@-&gt;&nbsp;size_t&nbsp;@-&gt;&nbsp;returning&nbsp;int)&lt;br&gt;&lt;br&gt;let&nbsp;floop&nbsp;fhandler&nbsp;name&nbsp;()&nbsp;=&lt;br&gt;       &nbsp;let&nbsp;handler&nbsp;=&nbsp;make&nbsp;handlers&nbsp;in&lt;br&gt;       &nbsp;let&nbsp;()&nbsp;=&nbsp;(&lt;br&gt;               &nbsp;setf&nbsp;handler&nbsp;topic_name&nbsp;name;&lt;br&gt;               &nbsp;setf&nbsp;handler&nbsp;topic_handler&nbsp;fhandler;&lt;br&gt;               &nbsp;setf&nbsp;handler&nbsp;topic_type&nbsp;0&lt;br&gt;       &nbsp;)&nbsp;in&lt;br&gt;       &nbsp;let&nbsp;()&nbsp;=&nbsp;(&lt;br&gt;               &nbsp;(*&nbsp;Gc.compact&nbsp;();&nbsp;#1&nbsp;*)&lt;br&gt;               &nbsp;let&nbsp;r&nbsp;=&nbsp;bus_init&nbsp;1&nbsp;bus_ptr&nbsp;in &lt;br&gt;               &nbsp;Printf.printf&nbsp;&quot;bus_init:&nbsp;%d\n&quot;&nbsp;r&lt;br&gt;       &nbsp;)&nbsp;in&lt;br&gt;       &nbsp;let&nbsp;r1&nbsp;=&nbsp;register_server&nbsp;(!@&nbsp;bus_ptr)&nbsp;name&nbsp;(addr&nbsp;handler)&nbsp;(of_int&nbsp;1)&nbsp;in&lt;br&gt;       &nbsp;(*&nbsp;let&nbsp;()&nbsp;=&nbsp;Gc.compact&nbsp;()&nbsp;in&nbsp;#2&nbsp;*)&lt;br&gt;       &nbsp;loop&nbsp;(!@&nbsp;bus_ptr)&lt;br&gt;&lt;br&gt;In&nbsp;case&nbsp;I&nbsp;comment&nbsp;out&nbsp;both&nbsp;calls&nbsp;to&nbsp;Gc.compact&nbsp;I&nbsp;see&lt;br&gt;&lt;br&gt;Cannot&nbsp;find&nbsp;handler&nbsp;(Resource&nbsp;temporarily&nbsp;unavailable)&lt;br&gt;Cannot&nbsp;get&nbsp;address&nbsp;handler&nbsp;item&nbsp;(Resource&nbsp;temporarily&nbsp;unavailable)&lt;br&gt;&lt;br&gt;after&nbsp;100-200&nbsp;test&nbsp;calls&nbsp;on&nbsp;x86&nbsp;and&nbsp;I&nbsp;get&nbsp;CallToExpiredClosure&nbsp;on&nbsp;ARM&nbsp;just&nbsp;on&nbsp;the&nbsp;first&nbsp;test&nbsp;call.&lt;br&gt;In&nbsp;case&nbsp;I&nbsp;uncomment&nbsp;#1&nbsp;or&nbsp;#2&nbsp;code&nbsp;line&nbsp;with&nbsp;Gc.compact&nbsp;call&nbsp;I&nbsp;got&nbsp;same&nbsp;error&nbsp;(Cannot&nbsp;find&nbsp;handler&nbsp;...)&nbsp;on&nbsp;first&nbsp;test&nbsp;call&nbsp;on&nbsp;x86&nbsp;too.&nbsp;I&#39;ve&nbsp;added&lt;/div&gt;&lt;div&gt;&lt;br&gt;       &nbsp;let&nbsp;addr1&nbsp;=&nbsp;Root.create&nbsp;fhandler&nbsp;in&lt;br&gt;       &nbsp;let&nbsp;addr2&nbsp;=&nbsp;Root.create&nbsp;handler&nbsp;in&lt;br&gt;&lt;/div&gt;&lt;br&gt;to&nbsp;begin&nbsp;of&nbsp;floop&nbsp;function&nbsp;but&nbsp;nothing&nbsp;changed&nbsp;on&nbsp;program&nbsp;behaviour&nbsp;under&nbsp;tests.&lt;br&gt;&lt;/div&gt;How&nbsp;can&nbsp;I&nbsp;protect&nbsp;struct&nbsp;handler&nbsp;and&nbsp;fhandler&nbsp;function&nbsp;pointer&nbsp;from&nbsp;garbage&nbsp;collection?&lt;br&gt;&lt;br&gt;&lt;/div&gt;WBR,&nbsp;ssp&lt;br&gt;&lt;/div&gt;<br>

</tt>

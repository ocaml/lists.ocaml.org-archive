<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hello,&lt;br&gt;&lt;br&gt;&lt;/div&gt;thank&nbsp;for&nbsp;your&nbsp;reply,&nbsp;it&nbsp;allow&nbsp;me&nbsp;partially&nbsp;resolve&nbsp;problem:&nbsp;code&nbsp;works&nbsp;on&nbsp;x86&nbsp;without&nbsp;any&nbsp;problems&nbsp;(yet&nbsp;with&nbsp;Gc.compact()&nbsp;calls&nbsp;insert&nbsp;after&nbsp;each&nbsp;line&nbsp;of&nbsp;code).&nbsp;But&nbsp;ARM&nbsp;version&nbsp;allways&nbsp;raises&nbsp;CallToExpiredClosure&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;callback.&lt;br&gt;&lt;/div&gt;I&#39;ve&nbsp;tried&nbsp;next&nbsp;variants&nbsp;to&nbsp;store&nbsp;callback&nbsp;if&nbsp;struct&nbsp;field:&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;existing&nbsp;toplevel&nbsp;function&nbsp;by&nbsp;name&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;store&nbsp;function&nbsp;name&nbsp;to&nbsp;toplevel&nbsp;ref&nbsp;and&nbsp;save&nbsp;it&nbsp;to&nbsp;struct&nbsp;field&nbsp;by&nbsp;!ref_name&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;by&nbsp;register&nbsp;closure&nbsp;to&nbsp;function&nbsp;(fun&nbsp;a&nbsp;b&nbsp;c&nbsp;d&nbsp;-&gt;&nbsp;top_level_function&nbsp;a&nbsp;b&nbsp;c&nbsp;d)&nbsp;with&nbsp;Ctypes.Root.create&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;by&nbsp;store&nbsp;same&nbsp;closure&nbsp;to&nbsp;Hashtbl.&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;by&nbsp;register&nbsp;finaliser&nbsp;with&nbsp;Gc.finalise&nbsp;for&nbsp;closure&nbsp;(and&nbsp;it&nbsp;has&nbsp;not&nbsp;been&nbsp;called)&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;this&nbsp;variants&nbsp;work&nbsp;on&nbsp;x86&nbsp;and&nbsp;do&nbsp;not&nbsp;work&nbsp;on&nbsp;ARM,&nbsp;i.e.&nbsp;first&nbsp;call&nbsp;to&nbsp;OCaml&nbsp;callback&nbsp;from&nbsp;C&nbsp;raises&nbsp;CallToExpiredClosure.&lt;/div&gt;It&nbsp;seems&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;problem&nbsp;at&nbsp;all.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;here&nbsp;is&nbsp;base&nbsp;questions:&lt;br&gt;-&nbsp;in&nbsp;case&nbsp;I&nbsp;store&nbsp;in&nbsp;C&nbsp;struct&nbsp;field&nbsp;existing&nbsp;toplevel&nbsp;function&nbsp;by&nbsp;name,&nbsp;may&nbsp;it&nbsp;be&nbsp;GC&#39;ed?&lt;br&gt;-what&nbsp;may&nbsp;cause&nbsp;CallToExpiredClosure&nbsp;raise&nbsp;too&nbsp;if&nbsp;I&nbsp;has&nbsp;only&nbsp;one&nbsp;callback&nbsp;to&nbsp;call&nbsp;and&nbsp;at&nbsp;C&nbsp;side&nbsp;this&nbsp;struct&nbsp;in&nbsp;GDB&nbsp;seems&nbsp;to&nbsp;be&nbsp;correct?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;WBR,&nbsp;ssp&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2017-05-04&nbsp;23:24&nbsp;GMT+05:00&nbsp;Daniel&nbsp;Bünzli&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:daniel.buenzli@erratique.ch&quot;&nbsp;target=&quot;_blank&quot;&gt;daniel.buenzli@erratique.ch&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;Thursday,&nbsp;4&nbsp;May&nbsp;2017&nbsp;at&nbsp;19:50,&nbsp;Serge&nbsp;Sivkov&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;How&nbsp;can&nbsp;I&nbsp;protect&nbsp;struct&nbsp;handler&nbsp;and&nbsp;fhandler&nbsp;function&nbsp;pointer&nbsp;from&nbsp;garbage&nbsp;collection?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;recently&nbsp;struggled&nbsp;with&nbsp;this&nbsp;on&nbsp;test&nbsp;code&nbsp;aswell.&nbsp;One&nbsp;thing&nbsp;that&nbsp;seems&nbsp;to&nbsp;work&nbsp;quite&nbsp;well&nbsp;is&nbsp;to&nbsp;store&nbsp;them&nbsp;in&nbsp;a&nbsp;toplevel &nbsp;reference.&lt;br&gt;<br>
&lt;br&gt;<br>
let&nbsp;fhandler&nbsp;=&nbsp;ref&nbsp;fhandler&lt;br&gt;<br>
&lt;br&gt;<br>
Best,&lt;br&gt;<br>
&lt;br&gt;<br>
Daniel&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>

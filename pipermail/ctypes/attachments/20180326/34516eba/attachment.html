<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none&quot;&gt;&lt;!--P{margin-top:0;margin-bottom:0;}&nbsp;--&gt;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&nbsp;style=&quot;font-size:12pt;color:#000000;background-color:#FFFFFF;font-family:Calibri,Arial,Helvetica,sans-serif;&quot;&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;sorry&nbsp;if&nbsp;I&nbsp;am&nbsp;cross-posting&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;https://discuss.ocaml.org/t/ctypes-and-structs-containing-strings/1752&quot;&gt;<br>
https://discuss.ocaml.org/t/ctypes-and-structs-containing-strings/1752&lt;/a&gt;&nbsp;but&nbsp;the&nbsp;post&nbsp;there&nbsp;got&nbsp;no&nbsp;attention&nbsp;and&nbsp;I&nbsp;was&nbsp;told&nbsp;that&nbsp;it&nbsp;was&nbsp;a&nbsp;better&nbsp;idea&nbsp;to&nbsp;ask&nbsp;on&nbsp;the&nbsp;mailing-list.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;`ocaml-opasswd`&nbsp;(&lt;a&nbsp;href=&quot;https://github.com/xapi-project/ocaml-opasswd&quot;&gt;https://github.com/xapi-project/ocaml-opasswd)&lt;/a&gt;&nbsp;we&nbsp;are&nbsp;using&nbsp;ctypes&nbsp;to&nbsp;bind&nbsp;some&nbsp;functions&nbsp;from&nbsp;`passwd.h`&nbsp;and&nbsp;`shadow.h`.&nbsp;In&nbsp;rare&nbsp;cases,&nbsp;when&nbsp;using&nbsp;the&nbsp;library&nbsp;to&nbsp;update&nbsp;an&nbsp;entry<br>
&nbsp;in&nbsp;the&nbsp;shadow&nbsp;file,&nbsp;it&nbsp;seems&nbsp;that&nbsp;the&nbsp;two&nbsp;strings&nbsp;in&nbsp;the&nbsp;passwd&nbsp;struct&nbsp;are&nbsp;read&nbsp;from&nbsp;uninitialised&nbsp;memory&nbsp;instead&nbsp;of&nbsp;being&nbsp;copies&nbsp;of&nbsp;the&nbsp;ocaml&nbsp;strings&nbsp;that&nbsp;we&nbsp;passed&nbsp;to&nbsp;create&nbsp;the&nbsp;new&nbsp;shadow&nbsp;struct.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;code&nbsp;is&nbsp;here:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/xapi-project/ocaml-opasswd/blob/master/lib/shadow.ml#L20&quot;&gt;<br>
https://github.com/xapi-project/ocaml-opasswd/blob/master/lib/shadow.ml#L20&lt;/a&gt;&nbsp;and&nbsp;my&nbsp;fear&nbsp;is&nbsp;that&nbsp;declaring&nbsp;those&nbsp;as&nbsp;`string`:&lt;br&gt;<br>
```&lt;br&gt;<br>
let&nbsp;sp_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;field&nbsp;shadow_t&nbsp;&quot;sp_name&quot;&nbsp;string&lt;br&gt;<br>
let&nbsp;sp_passwd&nbsp;=&nbsp;field&nbsp;shadow_t&nbsp;&quot;sp_passwd&quot;&nbsp;string&lt;br&gt;<br>
```&lt;br&gt;<br>
and&nbsp;then&nbsp;reading&nbsp;or&nbsp;writing&nbsp;them&nbsp;with&lt;br&gt;<br>
```&lt;br&gt;<br>
name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;getf&nbsp;!@sp&nbsp;sp_name;&lt;br&gt;<br>
passwd&nbsp;=&nbsp;getf&nbsp;!@sp&nbsp;sp_passwd;&lt;br&gt;<br>
```&lt;br&gt;<br>
and&lt;br&gt;<br>
```&lt;br&gt;<br>
setf&nbsp;sp_t&nbsp;sp_name&nbsp;sp.name;&lt;br&gt;<br>
setf&nbsp;sp_t&nbsp;sp_passwd&nbsp;sp.passwd;&lt;br&gt;<br>
```&lt;br&gt;<br>
could&nbsp;be&nbsp;wrong.&nbsp;Reading&nbsp;the&nbsp;documentation,&nbsp;it&nbsp;seems&nbsp;that&nbsp;strings&nbsp;view&nbsp;are&nbsp;doing&nbsp;the&nbsp;right&nbsp;copies&nbsp;and&nbsp;allocation&nbsp;there&nbsp;but&nbsp;I&nbsp;don't&nbsp;see&nbsp;other&nbsp;major&nbsp;points&nbsp;of&nbsp;failure.&nbsp;This&nbsp;code&nbsp;has&nbsp;been&nbsp;there&nbsp;for&nbsp;ages,&nbsp;and&nbsp;if&nbsp;it&nbsp;is&nbsp;wrong&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;how&nbsp;it&nbsp;should&nbsp;be&nbsp;fixed.<br>
&nbsp;To&nbsp;add&nbsp;some&nbsp;more&nbsp;context,&nbsp;the&nbsp;part&nbsp;of&nbsp;the&nbsp;code&nbsp;that&nbsp;sometimes&nbsp;seems&nbsp;to&nbsp;behave&nbsp;badly&nbsp;is<br>
&lt;a&nbsp;href=&quot;https://github.com/xapi-project/ocaml-opasswd/blob/master/lib/common.ml#L19-L21&quot;&gt;<br>
https://github.com/xapi-project/ocaml-opasswd/blob/master/lib/common.ml#L19-L21&lt;/a&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Is&nbsp;the&nbsp;declaration&nbsp;clearly&nbsp;wrong?&nbsp;How&nbsp;should&nbsp;I&nbsp;declare&nbsp;the&nbsp;strings&nbsp;and&nbsp;properly&nbsp;copy&nbsp;them&nbsp;between&nbsp;c&nbsp;and&nbsp;ocaml&nbsp;when&nbsp;using&nbsp;ctypes,&nbsp;should&nbsp;they&nbsp;be&nbsp;char&nbsp;ptr&nbsp;and&nbsp;handled&nbsp;manually?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;the&nbsp;help.&lt;br&gt;<br>
&lt;br&gt;<br>
Best,&lt;br&gt;<br>
Marcello&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>

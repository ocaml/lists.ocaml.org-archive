<tt>
I&nbsp;haven't&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;take&nbsp;a&nbsp;very&nbsp;long&nbsp;look,&nbsp;but&nbsp;I&nbsp;do&nbsp;have&nbsp;a&nbsp;few&nbsp;comments.&nbsp;Feel&nbsp;free&nbsp;to&nbsp;ignore&nbsp;me&nbsp;if&nbsp;I'm&nbsp;misunderstanding&nbsp;what&nbsp;you're&nbsp;trying&nbsp;to&nbsp;do&nbsp;:).&lt;br&gt;&lt;br&gt;You're&nbsp;refererencing&nbsp;some&nbsp;things&nbsp;in&nbsp;Async's&nbsp;Deferred&nbsp;module&nbsp;(like&nbsp;'Deferred.return',&nbsp;etc)&nbsp;with&nbsp;their&nbsp;qualified&nbsp;names,&nbsp;which&nbsp;is&nbsp;unnecessary:&nbsp;you&nbsp;can&nbsp;just&nbsp;use&nbsp;'return'.&nbsp;This&nbsp;is&nbsp;partially&nbsp;a&nbsp;style&nbsp;point,&nbsp;but&nbsp;Deferred&nbsp;is&nbsp;generally&nbsp;understood&nbsp;to&nbsp;be&nbsp;the&nbsp;top-level&nbsp;monad&nbsp;if&nbsp;you&nbsp;have&nbsp;Async&nbsp;open.&nbsp;(This&nbsp;is&nbsp;also&nbsp;the&nbsp;case&nbsp;for&nbsp;some&nbsp;functions&nbsp;in&nbsp;other&nbsp;modules,&nbsp;like&nbsp;printf,&nbsp;which&nbsp;is&nbsp;in&nbsp;the&nbsp;top&nbsp;level&nbsp;in&nbsp;Core.)&lt;br&gt;&lt;br&gt;You're&nbsp;also&nbsp;using&nbsp;the&nbsp;named&nbsp;'bind',&nbsp;'upon',&nbsp;etc.&nbsp;Unless&nbsp;there's&nbsp;a&nbsp;good&nbsp;reason&nbsp;to&nbsp;do&nbsp;that,&nbsp;I'd&nbsp;use&nbsp;the&nbsp;inline&nbsp;operators&nbsp;instead--they're&nbsp;much&nbsp;nicer&nbsp;to&nbsp;read.&nbsp;(&gt;&gt;=&nbsp;is&nbsp;bind,&nbsp;&gt;&gt;&gt;&nbsp;is&nbsp;upon,&nbsp;&gt;&gt;|&nbsp;is&nbsp;map)&nbsp;For&nbsp;example,&nbsp;with&nbsp;minimal&nbsp;other&nbsp;changes,&nbsp;this&nbsp;is&nbsp;how&nbsp;I'd&nbsp;write&nbsp;your&nbsp;'test_gen_server'&nbsp;function:&lt;br&gt;&lt;br&gt;&lt;div&nbsp;style=&quot;margin-left:&nbsp;40px;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;let&nbsp;test_gen_server&nbsp;()&nbsp;=&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;Test_server.start&nbsp;0&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;function&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;|&nbsp;Result.Error&nbsp;_&nbsp;-&gt;&nbsp;shutdown&nbsp;2&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;|&nbsp;Result.Ok&nbsp;gs&nbsp;&nbsp;&nbsp;-&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;gs&nbsp;1;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;gs&nbsp;2;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;Ivar.read&nbsp;(get&nbsp;gs)&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;function&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;3&nbsp;-&gt;&nbsp;shutdown&nbsp;gs&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;n&nbsp;-&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eprintf&nbsp;&quot;Error:&nbsp;Got&nbsp;%d\n&quot;&nbsp;n;&nbsp;(*&nbsp;eprintf&nbsp;goes&nbsp;to&nbsp;stderr&nbsp;instead&nbsp;of&nbsp;stdout&nbsp;*)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Shutdown.shutdown&nbsp;1&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;Also,&nbsp;I&nbsp;see&nbsp;a&nbsp;lot&nbsp;of&nbsp;use&nbsp;of&nbsp;upon,&nbsp;return,&nbsp;and&nbsp;ivars.&nbsp;There&nbsp;are&nbsp;certainly&nbsp;times&nbsp;to&nbsp;use&nbsp;all&nbsp;of&nbsp;them,&nbsp;but&nbsp;there&nbsp;are&nbsp;often&nbsp;nicer&nbsp;abstractions&nbsp;already&nbsp;in&nbsp;Async&nbsp;that&nbsp;do&nbsp;the&nbsp;hard&nbsp;work&nbsp;for&nbsp;you.&nbsp;Take&nbsp;a&nbsp;look&nbsp;at&nbsp;the&nbsp;Pipe&nbsp;module:&nbsp;I&nbsp;think&nbsp;you'll&nbsp;be&nbsp;able&nbsp;to&nbsp;eliminate&nbsp;a&nbsp;lot&nbsp;of&nbsp;code&nbsp;(and&nbsp;better&nbsp;types&nbsp;for&nbsp;your&nbsp;own&nbsp;interfaces&nbsp;will&nbsp;flow&nbsp;much&nbsp;more&nbsp;naturally&nbsp;from&nbsp;the&nbsp;underlying&nbsp;types).&nbsp;Generally&nbsp;functions&nbsp;that&nbsp;do&nbsp;deferred&nbsp;things&nbsp;should&nbsp;generally&nbsp;have&nbsp;a&nbsp;Deferred&nbsp;type.&nbsp;Don't&nbsp;use&nbsp;upon&nbsp;to&nbsp;try&nbsp;to&nbsp;give&nbsp;yourself&nbsp;functions&nbsp;of&nbsp;type&nbsp;'unit'.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;On&nbsp;Tuesday,&nbsp;July&nbsp;3,&nbsp;2012&nbsp;4:05:09&nbsp;AM&nbsp;UTC+8,&nbsp;orbitz&nbsp;wrote:&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Hello!&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;implemented&nbsp;an&nbsp;Erlang-like&nbsp;gen&nbsp;server&nbsp;in&nbsp;Async&nbsp;and&nbsp;was&nbsp;hoping&nbsp;someone&nbsp;familiar&nbsp;with&nbsp;Core&nbsp;might&nbsp;provide&nbsp;some&nbsp;feedback.&nbsp;&nbsp;Is&nbsp;the&nbsp;code&nbsp;good?&nbsp;&nbsp;Is&nbsp;the&nbsp;idea&nbsp;good?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;code&nbsp;is&nbsp;here:&lt;/div&gt;<br>
&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/orbitz/web_typed/blob/master/libs/ort_async/gen_server.ml&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/orbitz/web_&lt;wbr&gt;typed/blob/master/libs/ort_&lt;wbr&gt;async/gen_server.ml&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;an&nbsp;example&nbsp;is&nbsp;here:&lt;/div&gt;<br>
&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/orbitz/web_typed/blob/master/libs/ort_async/gen_server_test.ml&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/orbitz/web_&lt;wbr&gt;typed/blob/master/libs/ort_&lt;wbr&gt;async/gen_server_test.ml&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;thing&nbsp;that&nbsp;I&nbsp;do&nbsp;not&nbsp;like&nbsp;about&nbsp;this&nbsp;is&nbsp;the&nbsp;init&nbsp;function.&nbsp;&nbsp;The&nbsp;problem&nbsp;is:&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;want&nbsp;the&nbsp;init&nbsp;function&nbsp;to&nbsp;get&nbsp;a&nbsp;reference&nbsp;to&nbsp;itself&nbsp;so&nbsp;it&nbsp;can&nbsp;create&nbsp;other&nbsp;services&nbsp;and&nbsp;give&nbsp;itself&nbsp;to&nbsp;that&nbsp;service.&nbsp;&nbsp;The&nbsp;problem&nbsp;is,&nbsp;the&nbsp;type&nbsp;that&nbsp;represents&nbsp;the&nbsp;server&nbsp;doesn't&nbsp;exist&nbsp;when&nbsp;the&nbsp;init&nbsp;function&nbsp;is&nbsp;defined&nbsp;so&nbsp;I&nbsp;can't&nbsp;pass&nbsp;it&nbsp;a&nbsp;value.&nbsp;&nbsp;Instead&nbsp;I&nbsp;pass&nbsp;it&nbsp;the&nbsp;server&nbsp;stream&nbsp;and&nbsp;exited&nbsp;Ivar,&nbsp;but&nbsp;that&nbsp;is&nbsp;rather&nbsp;ugly&nbsp;since&nbsp;it&nbsp;really&nbsp;breaks&nbsp;the&nbsp;abstraction.&nbsp;&nbsp;Any&nbsp;suggestions?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;
</tt>

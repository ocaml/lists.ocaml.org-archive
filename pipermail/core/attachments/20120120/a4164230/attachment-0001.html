<tt>
&lt;div&gt;&gt;&nbsp;2)&nbsp;is&nbsp;perhaps&nbsp;a&nbsp;bit&nbsp;of&nbsp;of&nbsp;a&nbsp;low&nbsp;blow,&nbsp;since&nbsp;all&nbsp;the&nbsp;Async&nbsp;C&nbsp;code&nbsp;is&lt;/div&gt;&lt;div&gt;&gt;&nbsp;hidden&nbsp;in&nbsp;Core&nbsp;:-)&nbsp;There&nbsp;isn&#39;t&nbsp;a&nbsp;particularly&nbsp;large&nbsp;disparity&lt;/div&gt;&lt;div&gt;&gt;&nbsp;between&nbsp;the&nbsp;two&nbsp;if&nbsp;you&nbsp;include&nbsp;Core&nbsp;in&nbsp;the&nbsp;count.&lt;/div&gt;<br>
<br>
&lt;div&gt;..&lt;/div&gt;&lt;div&gt;&gt;&nbsp;Stephen&nbsp;read&nbsp;over&nbsp;lwt&nbsp;and&nbsp;was&nbsp;quite&nbsp;surprised&nbsp;by&nbsp;the&nbsp;amount&nbsp;and&lt;/div&gt;&lt;div&gt;&gt;&nbsp;nature&nbsp;of&nbsp;the&nbsp;c&nbsp;code,&nbsp;so&nbsp;on&nbsp;that&nbsp;basis&nbsp;I&nbsp;don&#39;t&nbsp;think&nbsp;this&nbsp;is&nbsp;just&nbsp;a&lt;/div&gt;&lt;div&gt;&gt;&nbsp;line-accounting&nbsp;trick.&nbsp; The&nbsp;c&nbsp;code&nbsp;in&nbsp;core&nbsp;is&nbsp;largely&nbsp;wrapping&lt;/div&gt;<br>
<br>
&lt;div&gt;&gt;&nbsp;system&nbsp;calls.&nbsp; But&nbsp;I&nbsp;believe&nbsp;that&nbsp;Stephen&nbsp;was&nbsp;saying&nbsp;that&lt;/div&gt;&lt;div&gt;&gt;&nbsp;significant&nbsp;fractions&nbsp;of&nbsp;the&nbsp;complexity&nbsp;of&nbsp;the&nbsp;runtime&nbsp;are&nbsp;in&nbsp;C.&lt;/div&gt;&lt;div&gt;&gt;&nbsp;Stephen,&nbsp;can&nbsp;you&nbsp;elaborate?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Core&nbsp;has&nbsp;approx&nbsp;3k&nbsp;lines&nbsp;of&nbsp;C&nbsp;code,&nbsp;most&nbsp;of&nbsp;which&nbsp;isn&#39;t&nbsp;relevant&nbsp;to&lt;/div&gt;<br>
<br>
&lt;div&gt;Async.&nbsp; If&nbsp;I&nbsp;had&nbsp;to&nbsp;write&nbsp;C&nbsp;bindings&nbsp;for&nbsp;Async&nbsp;from&nbsp;scratch&nbsp;without&lt;/div&gt;&lt;div&gt;using&nbsp;Core,&nbsp;I&nbsp;guess&nbsp;it&nbsp;would&nbsp;come&nbsp;in&nbsp;comfortably&nbsp;under&nbsp;1k&nbsp;lines,&nbsp;maybe&lt;/div&gt;&lt;div&gt;even&nbsp;under&nbsp;500.&nbsp; One&nbsp;just&nbsp;needs&nbsp;basic&nbsp;wrappers&nbsp;for&nbsp;system&nbsp;calls&nbsp;(read,&lt;/div&gt;<br>
<br>
&lt;div&gt;write,&nbsp;select)&nbsp;and&nbsp;OCaml&#39;s&nbsp;existing&nbsp;Thread&nbsp;API.&nbsp; The&nbsp;Async&nbsp;scheduler&lt;/div&gt;&lt;div&gt;and&nbsp;job&nbsp;handling&nbsp;are&nbsp;all&nbsp;implemented&nbsp;in&nbsp;OCaml&nbsp;using&nbsp;those.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;LWT&nbsp;has&nbsp;approx&nbsp;6k&nbsp;lines&nbsp;of&nbsp;C&nbsp;code,&nbsp;of&nbsp;which&nbsp;5k&nbsp;lives&nbsp;in&lt;/div&gt;<br>
<br>
&lt;div&gt;lwt_unix_unix.c&nbsp;and&nbsp;lwt_unix_stubs.c.&nbsp; I&#39;m&nbsp;far&nbsp;from&nbsp;an&nbsp;expert&nbsp;on&nbsp;LWT,&lt;/div&gt;&lt;div&gt;but&nbsp;it&nbsp;does&nbsp;appear&nbsp;that&nbsp;much&nbsp;of&nbsp;that&nbsp;code&nbsp;has&nbsp;to&nbsp;do&nbsp;with&nbsp;the&nbsp;scheduler&lt;/div&gt;&lt;div&gt;and&nbsp;job&nbsp;handling.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&nbsp;There&#39;s&nbsp;a&nbsp;reasonable&nbsp;amount&nbsp;of&nbsp;Lwt&nbsp;C&nbsp;code&nbsp;to&nbsp;deal&nbsp;with&nbsp;the&nbsp;&#39;detached&#39;&lt;/div&gt;<br>
<br>
&lt;div&gt;&gt;&nbsp;threads&nbsp;which&nbsp;are&nbsp;mapped&nbsp;to&nbsp;pthreads.&nbsp;That&#39;s&nbsp;unfortunately&nbsp;necessary&nbsp;for&lt;/div&gt;&lt;div&gt;&gt;&nbsp;the&nbsp;synchronous&nbsp;APIs&nbsp;in&nbsp;*NIX&nbsp;like&nbsp;DNS&nbsp;resolution&nbsp;and&nbsp;disk&nbsp;I/O&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;this&nbsp;does&nbsp;not&nbsp;imply&nbsp;a&nbsp;need&nbsp;for&nbsp;lots&nbsp;of&nbsp;C&nbsp;code.&nbsp; OCaml&nbsp;has&nbsp;a&lt;/div&gt;<br>
<br>
&lt;div&gt;thread&nbsp;API,&nbsp;and&nbsp;Async&nbsp;has&nbsp;OCaml&nbsp;code&nbsp;that&nbsp;uses&nbsp;threads&nbsp;to&nbsp;make&lt;/div&gt;&lt;div&gt;blocking&nbsp;calls&nbsp;(like&nbsp;DNS&nbsp;resolution&nbsp;and&nbsp;disk&nbsp;I/O).&nbsp; Having&nbsp;a&nbsp;basic&nbsp;C&lt;/div&gt;&lt;div&gt;wrapper&nbsp;around&nbsp;the&nbsp;blocking&nbsp;call&nbsp;that&nbsp;releases&nbsp;the&nbsp;OCaml&nbsp;lock&nbsp;is&lt;/div&gt;<br>
<br>
&lt;div&gt;sufficient.&nbsp; With&nbsp;that,&nbsp;one&nbsp;can&nbsp;do&nbsp;the&nbsp;rest&nbsp;in&nbsp;OCaml.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&nbsp;The&nbsp;actual&nbsp;socket&nbsp;handling&nbsp;in&nbsp;the&nbsp;Lwt&nbsp;UNIX&nbsp;backend&nbsp;is&nbsp;also&nbsp;quite&nbsp;complex&lt;/div&gt;&lt;div&gt;&gt;&nbsp;OCaml&nbsp;code,&nbsp;but&nbsp;this&nbsp;appear&nbsp;to&nbsp;be&nbsp;due&nbsp;to&nbsp;the&nbsp;need&nbsp;for&nbsp;cancellation&nbsp;to&nbsp;free&lt;/div&gt;<br>
<br>
&lt;div&gt;&gt;&nbsp;resources&nbsp;like&nbsp;fds&nbsp;when&nbsp;Lwt.cancel&nbsp;is&nbsp;invoked&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Again,&nbsp;I&nbsp;think&nbsp;this&nbsp;does&nbsp;not&nbsp;imply&nbsp;a&nbsp;need&nbsp;for&nbsp;lots&nbsp;of&nbsp;C&nbsp;code.&nbsp; Async&lt;/div&gt;&lt;div&gt;supports&nbsp;interruptible&nbsp;socket&nbsp;operations,&nbsp;and&nbsp;frees&nbsp;up&nbsp;file&lt;/div&gt;<br>
<br>
&lt;div&gt;descriptors&nbsp;when&nbsp;the&nbsp;interrupt&nbsp;happens.&nbsp; Of&nbsp;course,&nbsp;one&nbsp;needs&nbsp;access&lt;/div&gt;&lt;div&gt;to&nbsp;system&nbsp;calls,&nbsp;but&nbsp;the&nbsp;logic&nbsp;can&nbsp;be&nbsp;(and&nbsp;is,&nbsp;in&nbsp;Async)&nbsp;written&nbsp;in&lt;/div&gt;&lt;div&gt;OCaml.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&nbsp;One&nbsp;of&nbsp;my&nbsp;favourite&nbsp;things&nbsp;about&nbsp;Lwt&nbsp;is&nbsp;how&nbsp;it&nbsp;explicitly&nbsp;has&nbsp;a&lt;/div&gt;<br>
<br>
&lt;div&gt;&gt;&nbsp;src/core&nbsp;directory&nbsp;with&nbsp;the&nbsp;pure&nbsp;code,&nbsp;and&nbsp;src/unix&nbsp;with&nbsp;all&nbsp;the&lt;/div&gt;&lt;div&gt;&gt;&nbsp;evaluation&nbsp;modules&nbsp;to&nbsp;drive&nbsp;the&nbsp;cothreads.&nbsp;It&nbsp;makes&nbsp;porting&nbsp;it&nbsp;to&lt;/div&gt;&lt;div&gt;&gt;&nbsp;different&nbsp;platforms&nbsp;(or&nbsp;microkernels!)&nbsp;in&nbsp;stages&nbsp;an&nbsp;absolute&nbsp;breeze.&lt;/div&gt;<br>
<br>
&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&gt;&nbsp;That&nbsp;is&nbsp;in&nbsp;fact&nbsp;a&nbsp;great&nbsp;idea,&nbsp;and&nbsp;Stephen&nbsp;rearranged&nbsp;Async&nbsp;to&nbsp;follow&lt;/div&gt;&lt;div&gt;&gt;&nbsp;the&nbsp;same&nbsp;design.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yeah,&nbsp;I&nbsp;really&nbsp;liked&nbsp;that&nbsp;about&nbsp;LWT,&nbsp;and&nbsp;now&nbsp;that&nbsp;I&nbsp;copied&nbsp;the&nbsp;approach&nbsp;in&lt;/div&gt;<br>
<br>
&lt;div&gt;Async,&nbsp;I&nbsp;like&nbsp;that&nbsp;about&nbsp;Async&nbsp;too :-)&lt;/div&gt;<br>

</tt>

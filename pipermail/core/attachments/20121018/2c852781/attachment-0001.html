<tt>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;Great! &nbsp;Thanks&nbsp;for&nbsp;adding&nbsp;to&nbsp;Core/Async. &nbsp;Do&nbsp;you&nbsp;have&nbsp;a&nbsp;timeline&nbsp;for&nbsp;removing&nbsp;the&nbsp;race?&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;again&nbsp;for&nbsp;the&nbsp;quick&nbsp;responses&nbsp;fixes&nbsp;everyone.&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;/M&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Oct&nbsp;18,&nbsp;2012&nbsp;9:00&nbsp;PM,&nbsp;&quot;Stephen&nbsp;Weeks&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:sweeks@janestreet.com&quot;&gt;sweeks@janestreet.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;ended&nbsp;up&nbsp;adding&nbsp;an&nbsp;optional&nbsp;[?close_on_exec:bool]&nbsp;argument&nbsp;to:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;default&nbsp;|&lt;br&gt;<br>
 &nbsp;|------------------+---------|&lt;br&gt;<br>
 &nbsp;|&nbsp;Reader.open_file&nbsp;|&nbsp;true&nbsp; &nbsp; |&lt;br&gt;<br>
 &nbsp;|&nbsp;Writer.open_file&nbsp;|&nbsp;true&nbsp; &nbsp; |&lt;br&gt;<br>
 &nbsp;|&nbsp;Unix.openfile&nbsp; &nbsp; |&nbsp;false&nbsp; &nbsp;|&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;could&nbsp;be&nbsp;convinced&nbsp;to&nbsp;make&nbsp;the&nbsp;default&nbsp;[true]&nbsp;for&nbsp;[Unix.openfile]&lt;br&gt;<br>
also.&nbsp; As&nbsp;a&nbsp;drawback,&nbsp;it&nbsp;would&nbsp;be&nbsp;inconsistent&nbsp;with&nbsp;OCaml&#39;s&nbsp;and&nbsp;Core&#39;s&lt;br&gt;<br>
[Unix.openfile].&nbsp; But&nbsp;perhaps&nbsp;that&nbsp;inconsistency&nbsp;isn&#39;t&nbsp;bad.&nbsp; As&nbsp;Xavier&lt;br&gt;<br>
said&nbsp;on:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;&lt;a&nbsp;href=&quot;http://caml.inria.fr/mantis/view.php?id=5256&quot;&nbsp;target=&quot;_blank&quot;&gt;http://caml.inria.fr/mantis/view.php?id=5256&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
perhaps&nbsp;he&nbsp;should&nbsp;have&nbsp;had&nbsp;[Unix.openfile]&nbsp;set&nbsp;close-on-exec&nbsp;in&nbsp;the&lt;br&gt;<br>
first&nbsp;place,&nbsp;and&nbsp;he&nbsp;is&nbsp;considering&nbsp;doing&nbsp;it&nbsp;now.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;to&nbsp;the&nbsp;implementation,&nbsp;[Async.Unix.openfile]&nbsp;now&nbsp;looks&nbsp;like:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;In_thread.syscall_exn&nbsp;~name:&quot;openfile&quot;&nbsp;(fun&nbsp;()&nbsp;-&gt;&lt;br&gt;<br>
 &nbsp; &nbsp;let&nbsp;file_descr&nbsp;=&nbsp;Unix.openfile&nbsp;?perm&nbsp;file&nbsp;~mode&nbsp;in&lt;br&gt;<br>
 &nbsp; &nbsp;if&nbsp;close_on_exec&nbsp;then&nbsp;Unix.set_close_on_exec&nbsp;file_descr;&lt;br&gt;<br>
 &nbsp; &nbsp;file_descr)&lt;br&gt;<br>
&lt;br&gt;<br>
Once&nbsp;[Core.Unix]&nbsp;supports&nbsp;O_CLOEXEC,&nbsp;we&#39;ll&nbsp;pass&nbsp;it&nbsp;to&nbsp;[Unix.openfile]&lt;br&gt;<br>
and&nbsp;eliminate&nbsp;the&nbsp;race.&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;8:30&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Thanksgiving!&nbsp; The&nbsp;problematic&nbsp;code&nbsp;for&nbsp;me&nbsp;is&nbsp;in&nbsp;a&nbsp;pretty&nbsp;limited&nbsp;place&nbsp;so&lt;br&gt;<br>
&gt;&nbsp;doing&nbsp;it&nbsp;by&nbsp;hand&nbsp;isn&#39;t&nbsp;a&nbsp;problem.&nbsp;Thanks&nbsp;again&nbsp;for&nbsp;the&nbsp;help!&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;2:26&nbsp;PM,&nbsp;&quot;David&nbsp;House&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Sorry,&nbsp;I&nbsp;was&nbsp;thinking&nbsp;of&nbsp;something&nbsp;else.&nbsp;Of&nbsp;course&nbsp;when&nbsp;one&nbsp;uses&lt;br&gt;<br>
&gt;&gt;&nbsp;In_thread,&nbsp;you&nbsp;give&nbsp;away&nbsp;interruptability&nbsp;guarantees.&nbsp;(This&nbsp;is&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;whole&nbsp;point.)&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;You&#39;re&nbsp;also&nbsp;not&nbsp;allowed&nbsp;to&nbsp;use&nbsp;async&nbsp;code&nbsp;inside&nbsp;In_thread.run.&nbsp;(It&lt;br&gt;<br>
&gt;&gt;&nbsp;runs&nbsp;without&nbsp;the&nbsp;async&nbsp;lock.)&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;In&nbsp;principle,&nbsp;it&nbsp;is&nbsp;just&nbsp;a&nbsp;matter&nbsp;of&nbsp;aping&nbsp;the&nbsp;code&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;Writer.open_file,&nbsp;but&nbsp;adding&nbsp;in&nbsp;a&nbsp;call&nbsp;to&nbsp;set_close_on_exec.&nbsp;So&nbsp;this&lt;br&gt;<br>
&gt;&gt;&nbsp;is&nbsp;definitely&nbsp;possible,&nbsp;it&nbsp;just&nbsp;depends&nbsp;how&nbsp;much&nbsp;code&nbsp;you&#39;re&nbsp;willing&lt;br&gt;<br>
&gt;&gt;&nbsp;to&nbsp;duplicate.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&nbsp;think&nbsp;it&nbsp;should&nbsp;be&nbsp;possible&nbsp;to&nbsp;just&nbsp;do&nbsp;this&nbsp;all&nbsp;the&nbsp;time&nbsp;on&nbsp;Writer&lt;br&gt;<br>
&gt;&gt;&nbsp;and&nbsp;Reader;&nbsp;I&#39;ll&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;push&nbsp;that&nbsp;through.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;1:17&nbsp;PM,&nbsp;David&nbsp;House&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp;How&nbsp;so?&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp;let&nbsp;make_writer&nbsp;file&nbsp;=&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp; &nbsp;In_thread.run&nbsp;(fun&nbsp;()&nbsp;-&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp; &nbsp; &nbsp;let&nbsp;out_chan&nbsp;=&nbsp;Out_channel.create&nbsp;file&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp; &nbsp; &nbsp;let&nbsp;fd&nbsp;=&nbsp;Fd.of_out_channel&nbsp;out_chan&nbsp;Fd.Kind.File&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp; &nbsp; &nbsp;Unix.set_close_on_exec&nbsp;fd;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp; &nbsp; &nbsp;Writer.create&nbsp;writer)&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp;The&nbsp;closure&nbsp;will&nbsp;run&nbsp;still&nbsp;without&nbsp;being&nbsp;interrupted.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;1:15&nbsp;PM,&nbsp;Malcolm&nbsp;Matalka&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&nbsp;That&nbsp;won&#39;t&nbsp;work&nbsp;for&nbsp;me&nbsp;because&nbsp;making&nbsp;an&nbsp;fd&nbsp;and&nbsp;setting&nbsp;it&nbsp;to&nbsp;close&nbsp;on&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&nbsp;exec&nbsp;would&nbsp;become&nbsp;non-atomic&nbsp;again.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;2:07&nbsp;PM,&nbsp;David&nbsp;House&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&nbsp;It&#39;s&nbsp;very&nbsp;easy&nbsp;to&nbsp;make&nbsp;the&nbsp;blocking&nbsp;thing&nbsp;be&nbsp;non-blocking:&nbsp;throw&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&nbsp;whole&nbsp;thing&nbsp;into&nbsp;an&nbsp;In_thread.run.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;12:55&nbsp;PM,&nbsp;Malcolm&nbsp;Matalka&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&nbsp;Many&nbsp;thanks&nbsp;David,&nbsp;at&nbsp;least&nbsp;in&nbsp;this&nbsp;case&nbsp;a&nbsp;blocking&nbsp;open&nbsp;will&nbsp;mean&nbsp;I&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&nbsp;have&nbsp;bigger&nbsp;problems.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;12:48&nbsp;PM,&nbsp;David&nbsp;House&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;You&nbsp;should&nbsp;not&nbsp;normally&nbsp;use&nbsp;the&nbsp;In_channel&nbsp;or&nbsp;Out_channel&nbsp;modules&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;from&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;async,&nbsp;preferring&nbsp;Reader&nbsp;and&nbsp;Writer.&nbsp;This&nbsp;is&nbsp;because,&nbsp;as&nbsp;blocking&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;operations,&nbsp;they&nbsp;will&nbsp;kill&nbsp;all&nbsp;concurrency&nbsp;by&nbsp;blocking&nbsp;the&nbsp;main&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;async&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;thread.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;But&nbsp;in&nbsp;this&nbsp;case,&nbsp;I&nbsp;guess&nbsp;its&nbsp;use&nbsp;is&nbsp;warranted.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;Anyway,&nbsp;since&nbsp;{In,Out}_channel.create&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;deferred&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;result&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;type&nbsp;(it&#39;s&nbsp;in&nbsp;core,&nbsp;so&nbsp;this&nbsp;is&nbsp;impossible!),&nbsp;they&nbsp;do&nbsp;not&nbsp;use&nbsp;binds.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;I.e.&nbsp;the&nbsp;following&nbsp;code&nbsp;should&nbsp;run&nbsp;without&nbsp;interruptions:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp; &nbsp;let&nbsp;out_chan&nbsp;=&nbsp;Out_channel.create&nbsp;&quot;foo.txt&quot;&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp; &nbsp;let&nbsp;fd&nbsp;=&nbsp;Fd.of_out_channel&nbsp;out_chan&nbsp;Fd.Kind.File&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp; &nbsp;Unix.set_close_on_exec&nbsp;fd;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp; &nbsp;let&nbsp;writer&nbsp;=&nbsp;Writer.create&nbsp;writer&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp; &nbsp;...&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;10:53&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Does&nbsp;creating&nbsp;an&nbsp;out&nbsp;channel&nbsp;require&nbsp;a&nbsp;bind&nbsp;though?&nbsp; If&nbsp;so,&nbsp;can&nbsp;I&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;atomically&nbsp;create&nbsp;an&nbsp;out&nbsp;channel&nbsp;with&nbsp;close&nbsp;on&nbsp;exec&nbsp;set?&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Thanks&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;11:35&nbsp;AM,&nbsp;David&nbsp;House&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;The&nbsp;context&nbsp;switch&nbsp;points&nbsp;in&nbsp;async&nbsp;are&nbsp;exactly&nbsp;the&nbsp;points&nbsp;where&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;bind&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;appears.&nbsp;Blocks&nbsp;of&nbsp;code&nbsp;without&nbsp;a&nbsp;bind&nbsp;(or&nbsp;&gt;&gt;|,&nbsp;of&nbsp;course)&nbsp;inside&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;them&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;uninterruptedly.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Looking&nbsp;at&nbsp;the&nbsp;source&nbsp;of&nbsp;Writer.with_file,&nbsp;it&nbsp;looks&nbsp;like&nbsp;you&nbsp;do&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;not&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;have&nbsp;the&nbsp;guarantee&nbsp;that&nbsp;you&nbsp;want.&nbsp;It&nbsp;calls&nbsp;Unix.openfile,&nbsp;and&nbsp;then&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;there&nbsp;is&nbsp;a&nbsp;bind,&nbsp;so&nbsp;something&nbsp;else&nbsp;could&nbsp;run&nbsp;(depending,&nbsp;of&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;course,&nbsp;on&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;the&nbsp;exact&nbsp;pattern&nbsp;of&nbsp;concurrency&nbsp;in&nbsp;your&nbsp;program).&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Writer.of_out_channel,&nbsp;however,&nbsp;will&nbsp;give&nbsp;you&nbsp;the&nbsp;guarantees&nbsp;you&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;want.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;(It&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;deferred&nbsp;return&nbsp;type&nbsp;so&nbsp;cannot&nbsp;be&nbsp;doing&nbsp;binds&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;internally.)&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;10:28&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Am&nbsp;I&nbsp;guaranteed&nbsp;that&nbsp;no&nbsp;code&nbsp;will&nbsp;run&nbsp;between&nbsp;Writer.with_file&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;creating&nbsp;the&nbsp;FD&nbsp;and&nbsp;my&nbsp;handler&nbsp;being&nbsp;run&nbsp;so&nbsp;I&nbsp;can&nbsp;set&nbsp;close&nbsp;on&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;exec?&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;11:26&nbsp;AM,&nbsp;David&nbsp;House&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Oh,&nbsp;there&nbsp;is&nbsp;an&nbsp;easier&nbsp;fix&nbsp;than&nbsp;that.&nbsp;One&nbsp;can&nbsp;either&nbsp;call&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Unix.set_close_on_exec&nbsp;on&nbsp;the&nbsp;underlying&nbsp;file&nbsp;descriptor&nbsp;(use&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Writer.fd),&nbsp;or&nbsp;use&nbsp;Writer.of_out_channel.&nbsp;(Similarly&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Reader.)&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;10:19&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;One&nbsp;option&nbsp;I&nbsp;have&nbsp;is&nbsp;to&nbsp;write&nbsp;to&nbsp;a&nbsp;temporary&nbsp;filename&nbsp;then&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;spawn&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&#39;cp&#39;&nbsp;to&nbsp;copy&nbsp;the&nbsp;temp&nbsp;file&nbsp;to&nbsp;the&nbsp;actual&nbsp;file,&nbsp;but&nbsp;that&nbsp;seems&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;less&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;than&nbsp;ideal.&nbsp; The&nbsp;specific&nbsp;problem&nbsp;is&nbsp;I&nbsp;am&nbsp;writing&nbsp;shell&nbsp;scripts&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;will&nbsp;be&nbsp;run,&nbsp;and&nbsp;I&#39;m&nbsp;spawning&nbsp;shell&nbsp;scripts&nbsp;at&nbsp;the&nbsp;same&nbsp;time,&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;so&nbsp;if&nbsp;I&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;spawn&nbsp;a&nbsp;shell&nbsp;script&nbsp;while&nbsp;writing&nbsp;a&nbsp;shell&nbsp;script,&nbsp;the&nbsp;written&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;script&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;cannot&nbsp;be&nbsp;executed&nbsp;until&nbsp;the&nbsp;running&nbsp;one&nbsp;is&nbsp;completed.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;11:06&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;I&#39;m&nbsp;using&nbsp;Writer.with_file&nbsp;in&nbsp;this&nbsp;case.&nbsp; I&nbsp;poked&nbsp;around&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;source&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;code&nbsp;but&nbsp;my&nbsp;Unix&nbsp;knowledge&nbsp;isn&#39;t&nbsp;strong&nbsp;enough&nbsp;to&nbsp;know&nbsp;what&#39;s&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;right&nbsp;or&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;wrong.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;11:01&nbsp;AM,&nbsp;David&nbsp;House&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:dhouse@janestreet.com&quot;&gt;dhouse@janestreet.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Hmm,&nbsp;how&nbsp;are&nbsp;you&nbsp;opening&nbsp;the&nbsp;files?&nbsp;Xavier&nbsp;in&nbsp;that&nbsp;thread&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;claims&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;if&nbsp;you&nbsp;use&nbsp;Pervasives.open_in&nbsp;or&nbsp;Pervasives.open_out,&nbsp;then&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;close-on-exec&nbsp;will&nbsp;be&nbsp;set&nbsp;for&nbsp;those&nbsp;file&nbsp;descriptors.&nbsp;The&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;same&nbsp;is&nbsp;true&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;of&nbsp;Core.{In,Out}_channel.create.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;That&nbsp;being&nbsp;said,&nbsp;I&#39;m&nbsp;not&nbsp;actually&nbsp;sure&nbsp;that&nbsp;Async&#39;s&nbsp;Reader&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;and&nbsp;Writer&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;are&nbsp;doing&nbsp;this,&nbsp;which&nbsp;is&nbsp;a&nbsp;little&nbsp;embarrassing.&nbsp;It&#39;s&nbsp;quite&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;possible&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;this&nbsp;is&nbsp;deliberate;&nbsp;let&nbsp;me&nbsp;follow&nbsp;up&nbsp;internally,&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;15,&nbsp;2012&nbsp;at&nbsp;9:01&nbsp;AM,&nbsp;Malcolm&nbsp;Matalka&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmatalka@gmail.com&quot;&gt;mmatalka@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Hello,&nbsp;I&#39;m&nbsp;wondering&nbsp;if&nbsp;Core&nbsp;or&nbsp;Async&nbsp;addresses&nbsp;this&nbsp;bug:&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;&lt;a&nbsp;href=&quot;http://caml.inria.fr/mantis/view.php?id=5256&quot;&nbsp;target=&quot;_blank&quot;&gt;http://caml.inria.fr/mantis/view.php?id=5256&lt;/a&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;situation&nbsp;where&nbsp;I&#39;m&nbsp;reading/writing&nbsp;many&nbsp;files&nbsp;and&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;spawning&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;subprocesses&nbsp;in&nbsp;Async&nbsp;and&nbsp;the&nbsp;subprocesses&nbsp;are&nbsp;inheriting&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;the&nbsp;opened&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;FDs&nbsp;which&nbsp;is&nbsp;problematic&nbsp;for&nbsp;me.&nbsp; I&nbsp;am&nbsp;using&nbsp;the&nbsp;ocaml&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;stdlib&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;create_process&nbsp;for&nbsp;this&nbsp;as&nbsp;the&nbsp;Core&nbsp;version&nbsp;was&nbsp;causing&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;segfaults&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;me&nbsp;on&nbsp;OS&nbsp;X,&nbsp;but&nbsp;now&nbsp;I&nbsp;am&nbsp;mainly&nbsp;targeting&nbsp;Linux&nbsp;so&nbsp;I&nbsp;can&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;switch&nbsp;batch&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;to&nbsp;Core&#39;s&nbsp;create_process&nbsp;if&nbsp;it&nbsp;solves&nbsp;this&nbsp;issue.&nbsp; I&nbsp;poked&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;around&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;source&nbsp;code&nbsp;but&nbsp;didn&#39;t&nbsp;see&nbsp;anything&nbsp;in&nbsp;the&nbsp;comments&nbsp;about&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;what&nbsp;happens&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;to&nbsp;open&nbsp;fd&#39;s&nbsp;after&nbsp;forking.&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;Thanks,&lt;br&gt;<br>
&gt;&gt;&nbsp;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&nbsp;/M&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>

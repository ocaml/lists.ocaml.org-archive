<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [opam-devel] Generating .install file
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:opam-devel%40lists.ocaml.org?Subject=Re%3A%20%5Bopam-devel%5D%20Generating%20.install%20file&In-Reply-To=%3C1C10FCCB0E1A45EEA099081C8D24AB5C%40erratique.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000157.html">
   <LINK REL="Next"  HREF="000177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[opam-devel] Generating .install file</H1>
    <B>Daniel B&#252;nzli</B> 
    <A HREF="mailto:opam-devel%40lists.ocaml.org?Subject=Re%3A%20%5Bopam-devel%5D%20Generating%20.install%20file&In-Reply-To=%3C1C10FCCB0E1A45EEA099081C8D24AB5C%40erratique.ch%3E"
       TITLE="[opam-devel] Generating .install file">daniel.buenzli at erratique.ch
       </A><BR>
    <I>Mon Jul  8 13:23:38 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="000157.html">[opam-devel] Generating .install file
</A></li>
        <LI>Next message: <A HREF="000177.html">[opam-devel] Generating .install file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#161">[ date ]</a>
              <a href="thread.html#161">[ thread ]</a>
              <a href="subject.html#161">[ subject ]</a>
              <a href="author.html#161">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le lundi, 8 juillet 2013 &#224; 08:52, Thomas Gazagnaire a &#233;crit :
&gt;<i> And it needs to be named `&lt;package-name&gt;.install`.
</I>&gt;<i>  
</I>&gt;<i> Both of these limitation (root + package name should be known) are a bit severe,  
</I>Well not really:  

1) opam invokes the build system from the root so you are there.
2) The environement variable $OPAM_PACKAGE_NAME has the name  

So it's not that severe.
  
&gt;<i> so I was thinking to let the user specifies which install file he wants to use in the OPAM file, in the same spirit at the 'patch' fields. As nobody never really used this file as it was intended to (eg. generated by the build system)
</I>
Well there is now such a system... Having had a build crisis over the week-end, being fed up with any build system or meta build system doing half of the things I'd like them to do and/or in a undocumented way. And realizing that oasis was actually doing very little work for me but costing too much time in terms of how I can express that in there, how wait I cannot so I need to patch the _tags file anyway etc. I decided to reclaim control and I implemented a trivial system that should work for my (simple) packages. Basically it:

1) Uses an opam description file for the metadata (but doesn't do something particular with it, I got a little bit less obssesed by DRY to simplify things).  

2) Uses ocamlbuild to build. Write yourself the support files for libs (.mllib, etc). It's not hard and reasonably documented, no need for oasis to generate them.  

3) Write the META file yourself, it's not hard and handles optdeps stuff gracefully with exists_if. No need for oasis to generate them or meta program them. Here for example for Vg which has conditional support on js_of_ocaml:

<A HREF="https://github.com/dbuenzli/vg/blob/master/pkg/META">https://github.com/dbuenzli/vg/blob/master/pkg/META</A>

4) For building your package just list what you want to build and install in a simple script that handles conditionals. This is how this script looks for Vg:

<A HREF="https://github.com/dbuenzli/vg/blob/master/pkg/build">https://github.com/dbuenzli/vg/blob/master/pkg/build</A>

Yes it's hand written, I don't care, at least it's very explicit. It uses the functions of this *trivial* package-independent script:

<A HREF="https://github.com/dbuenzli/vg/blob/master/pkg/pkg-builder">https://github.com/dbuenzli/vg/blob/master/pkg/pkg-builder</A>

that just records what you `add` in which section (filtering out native stuff if you don't have support for it or choosing byte vs native for binaries). Then invokes a one shot `ocamlbuild` on what you added if you call `build` and generates an opam install file if you call `install` with what it recorded (see the invocation in the above `build` script).

This leads to the following simple opam package file:

<A HREF="https://github.com/dbuenzli/vg/blob/master/pkg/opam">https://github.com/dbuenzli/vg/blob/master/pkg/opam</A>

Best,

Daniel










</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000157.html">[opam-devel] Generating .install file
</A></li>
	<LI>Next message: <A HREF="000177.html">[opam-devel] Generating .install file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#161">[ date ]</a>
              <a href="thread.html#161">[ thread ]</a>
              <a href="subject.html#161">[ subject ]</a>
              <a href="author.html#161">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ocaml.org/listinfo/opam-devel">More information about the opam-devel
mailing list</a><br>
</body></html>

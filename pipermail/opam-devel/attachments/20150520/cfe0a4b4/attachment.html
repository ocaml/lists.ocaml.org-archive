<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Le mar.&nbsp;19&nbsp;mai&nbsp;2015&nbsp;à 10:50,&nbsp;Martin&nbsp;Lucina&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:martin@lucina.net&quot;&gt;martin@lucina.net&lt;/a&gt;&gt;&nbsp;a&nbsp;écrit :&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;[Re-sending&nbsp;with&nbsp;correct&nbsp;opam-devel&nbsp;address]&lt;br&gt;<br>
&lt;br&gt;<br>
Hi&nbsp;all,&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;m&nbsp;working&nbsp;on&nbsp;getting&nbsp;OCaml&nbsp;and&nbsp;Mirage&nbsp;OS&nbsp;running&nbsp;on&nbsp;top&nbsp;of&nbsp;the&nbsp;rumprun&lt;br&gt;<br>
unikernel&nbsp;stack[1].&lt;br&gt;<br>
&lt;br&gt;<br>
Rumprun&nbsp;provides&nbsp;a&nbsp;unikernel&nbsp;stack&nbsp;with&nbsp;a&nbsp;POSIXy&nbsp;(NetBSD-HEAD)&nbsp;userspace&lt;br&gt;<br>
and&nbsp;can&nbsp;run&nbsp;on&nbsp;Xen,&nbsp;QEMU/KVM,&nbsp;bare&nbsp;metal&nbsp;and&nbsp;POSIX&nbsp;userspace. &nbsp;The&lt;br&gt;<br>
resulting&nbsp;Mirage&nbsp;+&nbsp;rumprun&nbsp;unikernel&nbsp;will&nbsp;thus&nbsp;be&nbsp;able&nbsp;to&nbsp;run&nbsp;on&nbsp;all&nbsp;of&nbsp;the&lt;br&gt;<br>
platforms&nbsp;rumprun&nbsp;supports.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;first&nbsp;step&nbsp;to&nbsp;get&nbsp;this&nbsp;working&nbsp;is&nbsp;building&nbsp;an&nbsp;OCaml&nbsp;cross&nbsp;compiler&nbsp;that&lt;br&gt;<br>
uses&nbsp;the&nbsp;rumprun&nbsp;cross&nbsp;compiler&nbsp;as&nbsp;its&nbsp;backend&nbsp;for&nbsp;building&nbsp;C&nbsp;code&nbsp;and&lt;br&gt;<br>
linking.&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;ve&nbsp;researched&nbsp;the&nbsp;various&nbsp;cross-compilation&nbsp;options&nbsp;for&nbsp;OCaml&nbsp;and&nbsp;for&nbsp;now&lt;br&gt;<br>
have&nbsp;based&nbsp;my&nbsp;code&nbsp;off&nbsp;the&nbsp;approach&nbsp;used&nbsp;by&nbsp;Peter&nbsp;Zotov&nbsp;in&nbsp;his&lt;br&gt;<br>
`opam-android&#39;&nbsp;repository[2].&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;work&nbsp;in&nbsp;progress&nbsp;OPAM&nbsp;repository&nbsp;is&nbsp;here:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://github.com/mato/opam-rumprun&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/mato/opam-rumprun&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;enough&nbsp;to&nbsp;get&nbsp;an&nbsp;OCaml&nbsp;&quot;Hello,&nbsp;World&quot;&nbsp;running&nbsp;on&nbsp;rumprun,&nbsp;and&nbsp;I&#39;ve&lt;br&gt;<br>
also&nbsp;tested&nbsp;that&nbsp;the&nbsp;Unix&nbsp;package&nbsp;works&nbsp;as&nbsp;expected.&nbsp;So&nbsp;far&nbsp;so&nbsp;good.&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;in&nbsp;order&nbsp;to&nbsp;get&nbsp;Mirage&nbsp;to&nbsp;compile,&nbsp;I&nbsp;need&nbsp;to&nbsp;cross-compile&nbsp;Lwt&nbsp;and&lt;br&gt;<br>
that&nbsp;does&nbsp;not&nbsp;work&nbsp;as&nbsp;expected:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;$&nbsp;OCAMLFIND_TOOLCHAIN=rumprun&nbsp;ocaml&nbsp;&lt;a&nbsp;href=&quot;http://setup.ml&quot;&nbsp;target=&quot;_blank&quot;&gt;setup.ml&lt;/a&gt;&nbsp;-configure&nbsp;--prefix&nbsp;/home/mato/.opam/system/x86_64-rumprun-netbsd/&nbsp;--disable-libev&lt;br&gt;<br>
&lt;br&gt;<br>
Results&nbsp;in:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;not&nbsp;checking&nbsp;for&nbsp;pkg-config&lt;br&gt;<br>
 &nbsp; &nbsp;not&nbsp;checking&nbsp;for&nbsp;libev&lt;br&gt;<br>
 &nbsp; &nbsp;testing&nbsp;for&nbsp;pthread:&nbsp;...........................&nbsp;unavailable&lt;br&gt;<br>
 &nbsp; &nbsp;not&nbsp;checking&nbsp;for&nbsp;glib&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;The&nbsp;following&nbsp;recquired&nbsp;C&nbsp;libraries&nbsp;are&nbsp;missing:&nbsp;pthread.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;reason&nbsp;this&nbsp;happens&nbsp;is&nbsp;that&nbsp;&lt;a&nbsp;href=&quot;http://discover.ml&quot;&nbsp;target=&quot;_blank&quot;&gt;discover.ml&lt;/a&gt;&nbsp;is&nbsp;invoking&nbsp;the&nbsp;following&lt;br&gt;<br>
compile&nbsp;command:&lt;br&gt;<br>
&lt;br&gt;<br>
/home/mato/projects/rumpkernel/rumprun/app-tools/rumprun-xen-cc&nbsp;-fno-defer-pop&nbsp;-Wall&nbsp;-D_FILE_OFFSET_BITS=64&nbsp;-D_REENTRANT&nbsp;-c&nbsp;-I/usr/include&nbsp;-o&nbsp;/tmp/lwt_stubf12ac7.o&nbsp;-I/home/mato/.opam/system/x86_64-rumprun-netbsd/lib/ocaml&nbsp;/tmp/lwt_stubf12ac7.c&lt;br&gt;<br>
&lt;br&gt;<br>
Note&nbsp;the&nbsp;inclusion&nbsp;of&nbsp;-I/usr/include&nbsp;--&nbsp;this&nbsp;is&nbsp;presumably&nbsp;there&nbsp;so&nbsp;that&lt;br&gt;<br>
the&nbsp;system&nbsp;OCaml&nbsp;compiler&#39;s&nbsp;headers&nbsp;are&nbsp;available,&nbsp;however&nbsp;it&nbsp;results&nbsp;in&nbsp;a&lt;br&gt;<br>
conflict&nbsp;between&nbsp;the&nbsp;NetBSD&nbsp;headers&nbsp;provided&nbsp;by&nbsp;rumprun&nbsp;and&nbsp;the&nbsp;system&lt;br&gt;<br>
headers.&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;can&nbsp;be&nbsp;done&nbsp;to&nbsp;fix&nbsp;the&nbsp;above?&nbsp;Should&nbsp;I&nbsp;be&nbsp;using&nbsp;a&nbsp;host&nbsp;compiler&nbsp;built&lt;br&gt;<br>
and&nbsp;installed&nbsp;by&nbsp;OPAM&nbsp;rather&nbsp;than&nbsp;the&nbsp;system&nbsp;compiler&nbsp;(4.02.1-1ppa3~precise&lt;br&gt;<br>
on&nbsp;Debian&nbsp;wheezy).&nbsp;[I&#39;ll&nbsp;try&nbsp;this&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;helps...]&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;tried&nbsp;to&nbsp;hack&nbsp;around&nbsp;the&nbsp;problem&nbsp;by&nbsp;using&nbsp;--enable-android-target,&nbsp;that&lt;br&gt;<br>
causes&nbsp;&lt;a&nbsp;href=&quot;http://discover.ml&quot;&nbsp;target=&quot;_blank&quot;&gt;discover.ml&lt;/a&gt;&nbsp;to&nbsp;succeed&nbsp;and&nbsp;the&nbsp;build&nbsp;then&nbsp;proceeds,&nbsp;failing&nbsp;on&nbsp;a&lt;br&gt;<br>
different&nbsp;problem:&lt;br&gt;<br>
&lt;br&gt;<br>
E:&nbsp;Failure(&quot;Expected&nbsp;built&nbsp;file&nbsp;&#39;_build/src/unix/dlllwt-unix_stubs.so&#39;&nbsp;doesn&#39;t&nbsp;exist.&quot;)&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;expected;&nbsp;the&nbsp;rumprun&nbsp;toolchain&nbsp;does&nbsp;not&nbsp;support&nbsp;dynamic&nbsp;linking&lt;br&gt;<br>
and&nbsp;I&nbsp;have&nbsp;configured&nbsp;the&nbsp;ocaml-rumprun&nbsp;compiler&nbsp;with&nbsp;-no-shared-libs.&nbsp;Is&lt;br&gt;<br>
there&nbsp;some&nbsp;way&nbsp;to&nbsp;tell&nbsp;OASIS&nbsp;to&nbsp;not&nbsp;expect&nbsp;any&nbsp;shared&nbsp;libraries&nbsp;to&nbsp;be&lt;br&gt;<br>
built?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;suppose&nbsp;it&nbsp;will&nbsp;require&nbsp;to&nbsp;patch&nbsp;src/oasis/OASISLibrary&nbsp;l201&nbsp;to&nbsp;have&nbsp;ext_lib&nbsp;be&nbsp;an&nbsp;option&nbsp;rather&nbsp;than&nbsp;a&nbsp;string.&nbsp;OASIS&nbsp;can&nbsp;be&nbsp;forked&nbsp;and&nbsp;PR&nbsp;sent&nbsp;on&nbsp;github,&nbsp;feel&nbsp;free&nbsp;to&nbsp;send&nbsp;a&nbsp;PR&nbsp;about&nbsp;that.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
General&nbsp;questions:&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;Is&nbsp;this&nbsp;the&nbsp;right&nbsp;strategy&nbsp;for&nbsp;building&nbsp;an&nbsp;OCaml&nbsp;cross-compiler&nbsp;and&lt;br&gt;<br>
integrating&nbsp;with&nbsp;OPAM?&lt;br&gt;<br>
&lt;br&gt;<br>
AFAICS&nbsp;there&nbsp;are&nbsp;multiple&nbsp;approaches&nbsp;being&nbsp;used&nbsp;in&nbsp;the&nbsp;wild&nbsp;and&nbsp;OCaml&lt;br&gt;<br>
upstream&nbsp;*claims*&nbsp;to&nbsp;include&nbsp;support&nbsp;for&nbsp;cross-compiling&nbsp;via&nbsp;-host&nbsp;and&lt;br&gt;<br>
-target,&nbsp;however&nbsp;that&nbsp;support&nbsp;is&nbsp;not&nbsp;actually&nbsp;functional?&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;the&nbsp;rumprun&nbsp;support&nbsp;to&nbsp;be&nbsp;as&nbsp;user-friendly&nbsp;as&nbsp;possible,&nbsp;we&nbsp;need&nbsp;an&nbsp;easy&lt;br&gt;<br>
way&nbsp;of&nbsp;switching&nbsp;the&nbsp;backend&nbsp;rumprun&nbsp;cross-compiler&nbsp;and&nbsp;linker&nbsp;used&nbsp;by&lt;br&gt;<br>
ocaml&nbsp;when&nbsp;the&nbsp;user&nbsp;wants&nbsp;to&nbsp;switch&nbsp;platforms&nbsp;or&nbsp;architectures.&nbsp;The&lt;br&gt;<br>
approach&nbsp;used&nbsp;by&nbsp;the&nbsp;android&nbsp;repository&nbsp;I&nbsp;based&nbsp;my&nbsp;work&nbsp;off&nbsp;implies&nbsp;either:&lt;br&gt;<br>
&lt;br&gt;<br>
a)&nbsp;the&nbsp;user&nbsp;would&nbsp;have&nbsp;to&nbsp;*reinstall*&nbsp;the&nbsp;cross&nbsp;compiler&nbsp;(specifying&nbsp;eg.&lt;br&gt;<br>
RUMPRUN_CC&nbsp;in&nbsp;the&nbsp;environment)&nbsp;and&nbsp;all&nbsp;packages&nbsp;using&nbsp;native&nbsp;code&nbsp;whenever&lt;br&gt;<br>
they&nbsp;want&nbsp;to&nbsp;switch&nbsp;the&nbsp;backend&nbsp;compiler.&lt;br&gt;<br>
&lt;br&gt;<br>
b)&nbsp;we&nbsp;would&nbsp;have&nbsp;to&nbsp;provide&nbsp;different&nbsp;opam&nbsp;packages&nbsp;of&nbsp;the&nbsp;compiler&nbsp;and&lt;br&gt;<br>
native&nbsp;libraries&nbsp;(Lwt)&nbsp;for&nbsp;each&nbsp;platform/arch&nbsp;combination&nbsp;supported&nbsp;by&lt;br&gt;<br>
rumprun.&nbsp;This&nbsp;is&nbsp;unmanageable.&lt;br&gt;<br>
&lt;br&gt;<br>
2)&nbsp;Is&nbsp;there&nbsp;an&nbsp;easy&nbsp;way&nbsp;to&nbsp;switch&nbsp;ocamlc&nbsp;and&nbsp;the&nbsp;various&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&lt;br&gt;<br>
build&nbsp;system(s)&nbsp;involved&nbsp;into&nbsp;a&nbsp;verbose&nbsp;mode&nbsp;so&nbsp;that&nbsp;I&nbsp;can&nbsp;see&nbsp;what&lt;br&gt;<br>
compilers&nbsp;are&nbsp;being&nbsp;invoked&nbsp;and&nbsp;why&nbsp;they&nbsp;fail?&nbsp;At&nbsp;the&nbsp;moment&nbsp;I&#39;m&nbsp;using&lt;br&gt;<br>
`strace&#39;&nbsp;for&nbsp;this&nbsp;:-/&lt;br&gt;<br>
&lt;br&gt;<br>
All&nbsp;ideas&nbsp;and&nbsp;help&nbsp;much&nbsp;appreciated,&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Martin&lt;br&gt;<br>
&lt;br&gt;<br>
[1]&nbsp;&lt;a&nbsp;href=&quot;http://wiki.rumpkernel.org/Repo%3A-rumprun&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.rumpkernel.org/Repo%3A-rumprun&lt;/a&gt;&lt;br&gt;<br>
[2]&nbsp;&lt;a&nbsp;href=&quot;https://github.com/whitequark/opam-android&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/whitequark/opam-android&lt;/a&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
opam-devel&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:opam-devel@lists.ocaml.org&quot;&nbsp;target=&quot;_blank&quot;&gt;opam-devel@lists.ocaml.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ocaml.org/listinfo/opam-devel&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ocaml.org/listinfo/opam-devel&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
